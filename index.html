<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Controle de Cascos e Caixas - Distribuidora Garcia</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* =========================
   Estilos Gerais / Tema
========================= */
:root{
  --cor-principal:#b71c1c;
  --cor-secundaria:#1976d2;
  --font-base-size:16px;
  --font-lg:18px;
  --font-xl:22px;
  --logo-altura:140px;
}

body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  margin:0;background:#f0f2f5;color:#333;
  font-size:var(--font-base-size);
}
.container{ max-width:1000px; margin:auto; padding:10px; }
.box{ background:#fff; padding:20px; border-radius:10px; margin-bottom:20px;
      box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24); }
h1,h2,h3,h4{ text-align:center; color:var(--cor-principal); margin-top:0; }
h1{ font-size:calc(var(--font-xl) + 6px); }
h2{ font-size:var(--font-xl); margin-bottom:20px; }
label{ font-weight:700; display:block; margin-top:12px; margin-bottom:6px; }
input,select,button,textarea{
  width:100%; padding:12px; margin-top:5px; border-radius:8px; border:1px solid #ccc; box-sizing:border-box; font-size:1em;
}
button{ background:var(--cor-principal); color:#fff; font-weight:800; cursor:pointer; border:none; margin-top:20px; transition:.2s; border-radius:10px; }
button:hover{ opacity:.9; transform:translateY(-1px); }
button.secondary{ background:var(--cor-secundaria); }
button.whatsapp{ background:#25D366; }

.grid-2-col{ display:grid; grid-template-columns:1fr 1fr; gap:20px; }
.grid-3-col{ display:grid; grid-template-columns:3fr 2fr 1fr; gap:15px; }

/* =========================
   Header / Logos
========================= */
.header{
  display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:16px;
  padding:16px; background:#fff; border-radius:10px; margin-bottom:20px; box-shadow:0 1px 3px rgba(0,0,0,.12);
}
.header img{ height:var(--logo-altura); width:auto; object-fit:contain; }

/* =========================
   Login
========================= */
#loginScreen{ padding-top:50px; position:relative; }
#loginScreen .box{ max-width:420px; margin:auto; }
#loginScreen .box img{ max-width:280px; display:block; margin:0 auto 20px; }
.login-watermark{ position:fixed; right:12px; bottom:12px; width:180px; opacity:.85; pointer-events:none; z-index:15; }

/* =========================
   Abas
========================= */
.tabs{ display:flex; flex-wrap:wrap; justify-content:space-around; margin-bottom:20px; background:#e9ecef; padding:6px; border-radius:10px; }
.tabs button{ flex:1; min-width:120px; margin:6px; padding:12px; border-radius:8px; background:transparent; font-weight:800; cursor:pointer; color:#495057; border:none; transition:.2s; }
.tabs button.active{ background:var(--cor-principal); color:#fff; box-shadow:0 2px 5px rgba(0,0,0,.2); }

/* =========================
   Listas / Itens
========================= */
.item-lista{
  display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #e9ecef; padding:16px 6px; flex-wrap:wrap; gap:10px;
}
.item-lista:last-child{ border-bottom:none; }
.item-lista span{ flex:1; min-width:150px; }
.item-lista .divida{ font-weight:900; color:var(--cor-principal); }
.item-lista .botoes{ display:flex; flex-wrap:wrap; gap:6px; }
.item-lista button{ width:auto; margin:0; padding:10px 14px; font-size:.95em; border-radius:10px; }
.item-lista button.editar{ background:#f57c00; }
.item-lista button.devolver{ background:#388e3c; }
.item-lista button.imprimir-recibo{ background:#6a1b9a; }
.item-lista button.apagar{ background:#444; }
.item-lista button.apagar-cliente{ background:#9e9e9e; }

/* =========================
   Busca / Home / Estoque
========================= */
.barra-pesquisa{ margin-bottom:20px; padding:12px; }
.home-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; }
.home-grid .box{ text-align:center; }
.home-grid .stat-number{ font-size:2.6em; font-weight:900; color:var(--cor-principal); }
.estoque-item{ display:grid; grid-template-columns:1fr auto; align-items:center; gap:10px; }
.estoque-item input{ width:110px; text-align:center; }

/* =========================
   Apagados / Notificações
========================= */
.apagado-item{ background:#f9f9f9; border:1px solid #eee; padding:15px; margin-bottom:10px; border-radius:8px; }
.apagado-item p{ margin:5px 0; }
.apagado-item strong{ color:#555; }

.notificacao{ background:#fff7f7; border:1px solid #f3dada; padding:12px; border-radius:10px; margin-bottom:10px; cursor:pointer; }
.notificacao:hover{ background:#ffecec; }
.badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:800; }
.badge-hoje{ background:#fff3cd; color:#856404; }
.badge-atraso{ background:#f8d7da; color:#721c24; }

/* =========================
   Modais
========================= */
.modal{ display:none; position:fixed; z-index:9999; inset:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,.4); }
.modal-content{
  background:#fff; margin:4% auto; padding:20px; border-radius:12px; max-width:760px; box-shadow:0 10px 30px rgba(0,0,0,.2);
}
.close-button{ float:right; font-size:28px; cursor:pointer; }

/* =========================
   Responsivo
========================= */
@media(max-width:768px){
  .grid-2-col,.home-grid{ grid-template-columns:1fr; }
  .item-lista{ flex-direction:column; align-items:flex-start; }
  .item-lista .botoes{ width:100%; margin-top:10px; }
  :root{ --logo-altura:120px; }
}

/* =========================
   @media print (base TX20)
========================= */
@media print{
  body{ font-size:19px; }
  h1{ font-size:28px; }
  h2{ font-size:23px; }
  .header img{ height:200px !important; }
  table{ font-size:19px; }
  th, td{ padding:10px; }
  button{ display:none !important; }
}
</style>
</head>
<body>

<div class="container">
  <!-- LOGIN -->
  <div id="loginScreen">
    <div class="box">
      <img src="logo.png" alt="Logo Distribuidora Garcia">
      <h1>Login</h1>
      <form id="formLogin">
        <label for="loginUsuario">Utilizador:</label>
        <input type="text" id="loginUsuario" required>
        <label for="loginSenha">Palavra-passe:</label>
        <input type="password" id="loginSenha" required>
        <button type="submit">Entrar</button>
        <p id="loginErro" style="color:red;text-align:center;font-weight:bold;"></p>
      </form>
    </div>
    <img src="volt.png" alt="VOLT" class="login-watermark">
  </div>

  <!-- APP -->
  <div id="app" style="display:none;">
    <div class="header">
      <img src="logo.png?v=1" class="logo-garcia" alt="Distribuidora Garcia">
      <h1 class="app-title"></h1>
      <img src="volt.png?v=1" class="logo-volt" alt="VOLT">
    </div>

    <div class="tabs">
      <button id="tabHome" class="active">Home</button>
      <button id="tabNotificacoes">Notificações</button>
      <button id="tabFisicos">Clientes Físicos</button>
      <button id="tabBares">Bares</button>
      <button id="tabAdicionarCliente">Adicionar Cliente</button>
      <button id="tabEstoque">Estoque</button>
      <button id="tabApagados">Registos Apagados</button>
    </div>

    <!-- HOME -->
    <div id="conteudoHome">
      <div class="box home-grid">
        <div class="box">
          <h3>Total de Itens Pendentes</h3>
          <p id="totalItensPendentes" class="stat-number">0</p>
        </div>
        <div class="box">
          <h3>Clientes com Débitos</h3>
          <p id="totalClientesComDebitos" class="stat-number">0</p>
        </div>
      </div>

      <div class="box">
        <h2>Relatórios e Extratos</h2>
        <div class="grid-2-col">
          <button id="btnImprimirResumoDiario">Imprimir Resumo de Hoje</button>
          <button id="btnImprimirExtratoEmprestimos" class="secondary">Imprimir Relatório Geral</button>
        </div>
        <div class="grid-2-col" style="margin-top:10px;">
          <div>
            <label for="dataResumoDia">Escolher data para resumo:</label>
            <input type="date" id="dataResumoDia">
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="btnImprimirResumoPorData" class="secondary">Imprimir Resumo por Data</button>
          </div>
        </div>
      </div>

      <div class="box">
        <h2>Histórico de Empréstimos do Dia</h2>
        <div id="historicoDoDia"></div>
      </div>
    </div>

    <!-- NOTIFICAÇÕES -->
    <div id="conteudoNotificacoes" style="display:none;">
      <div class="box">
        <h2>Notificações</h2>
        <div id="listaNotificacoes"></div>
      </div>
    </div>

    <!-- FÍSICOS -->
    <div id="conteudoFisicos" style="display:none;">
      <div class="box">
        <h2>Clientes Físicos</h2>
        <input type="search" id="pesquisaFisicos" class="barra-pesquisa" placeholder="Pesquisar por nome...">
        <div id="listaClientesFisicos"></div>
      </div>
    </div>

    <!-- BARES -->
    <div id="conteudoBares" style="display:none;">
      <div class="box">
        <h2>Bares</h2>
        <input type="search" id="pesquisaBares" class="barra-pesquisa" placeholder="Pesquisar por nome...">
        <div id="listaClientesBares"></div>
      </div>
    </div>

    <!-- ADD/EDIT CLIENTE -->
    <div id="conteudoAdicionarCliente" style="display:none;">
      <form id="formCliente" class="box">
        <h2 id="formClienteTitulo">Registar Novo Cliente</h2>
        <div class="grid-2-col">
          <div><label for="nomeCliente">Nome:</label><input type="text" id="nomeCliente" required></div>
          <div>
            <label for="tipoCliente">Tipo:</label>
            <select id="tipoCliente" required>
              <option value="">Selecione</option>
              <option value="fisico">Físico</option>
              <option value="bar">Bar</option>
            </select>
          </div>
        </div>
        <div class="grid-2-col">
          <div><label for="enderecoCliente">Endereço:</label><input type="text" id="enderecoCliente" required></div>
          <div><label for="numeroCliente">Número:</label><input type="text" id="numeroCliente" required></div>
        </div>
        <div>
          <label for="telefoneCliente">Telefone (com código do país, ex: 55119...):</label>
          <input type="tel" id="telefoneCliente" placeholder="Ex: 5511987654321">
        </div>
        <button type="submit" id="btnSalvarCliente">Guardar Cliente</button>
        <button type="button" id="btnCancelarEdicao" class="secondary" style="display:none;">Cancelar Edição</button>
      </form>
    </div>

    <!-- ESTOQUE -->
    <div id="conteudoEstoque" style="display:none;">
      <div class="box">
        <h2>Gestão de Estoque</h2>
        <div id="listaEstoque"></div>
        <button id="btnImprimirExtratoEstoque" class="secondary">Imprimir Extrato de Estoque</button>
      </div>
    </div>

    <!-- APAGADOS -->
    <div id="conteudoApagados" style="display:none;">
      <div class="box">
        <h2>Registos Apagados</h2>
        <div id="listaRegistrosApagados"></div>
      </div>
    </div>
  </div>
</div>

<!-- =========================
     MODAIS
========================= -->

<!-- Histórico do Cliente + Novo Empréstimo -->
<div id="modalHistoricoCliente" class="modal">
  <div class="modal-content">
    <span class="close-button" onclick="fecharModal('modalHistoricoCliente')">&times;</span>
    <h2 id="modalTituloCliente">Histórico do Cliente</h2>
    <div id="infoClienteModal" class="info-cliente-modal"></div>
    <div id="resumoDividaCliente" class="resumo-divida-cliente"></div>

    <div class="box">
      <h3>Ações do Cliente</h3>
      <div class="grid-2-col">
        <button class="whatsapp" id="btnNotificarWhatsapp">Gerar Mensagem de Cobrança</button>
        <button id="btnImprimirRelatorioCliente" class="secondary">Imprimir Relatório Completo do Cliente</button>
      </div>
    </div>

    <!-- Cadastro de empréstimo -->
    <form id="formEmprestimo">
      <h3>Registar Novo Empréstimo</h3>

      <div class="grid-2-col">
        <div>
          <label for="vendedorEmprestimo">Vendedor que emprestou:</label>
          <select id="vendedorEmprestimo" required>
            <option value="">Selecione</option>
            <option>JUNIOR</option>
            <option>ANA CLARA</option>
            <option>CARLOS VITOR</option>
            <option>CID</option>
            <option>ELIEUDA</option>
            <option>CABEÇÃO</option>
          </select>
        </div>
        <div>
          <label for="dataEmprestimo">Data e Hora do Empréstimo:</label>
          <input type="datetime-local" id="dataEmprestimo" required>
        </div>
      </div>

      <div>
        <label for="dataDevolucao">Data de Devolução (prevista):</label>
        <input type="date" id="dataDevolucao" required>
      </div>

      <div class="grid-3-col">
        <div>
          <label for="marcaCasco">Marca:</label>
          <select id="marcaCasco"></select>
        </div>
        <div>
          <label for="tamanhoCasco">Tamanho:</label>
          <select id="tamanhoCasco"></select>
        </div>
        <div>
          <label for="qtdCasco">Qtd:</label>
          <input type="number" id="qtdCasco" min="0" value="0">
        </div>
      </div>

      <h4>Caixas</h4>
      <div class="grid-2-col">
        <div>
          <label for="tipoCaixa">Tipo:</label>
          <select id="tipoCaixa"></select>
        </div>
        <div>
          <label for="qtdCaixa">Qtd:</label>
          <input type="number" id="qtdCaixa" min="0" value="0">
        </div>
      </div>

      <button type="submit">Adicionar Empréstimo</button>
    </form>

    <div class="box">
      <h3>Empréstimos Registados</h3>
      <div id="listaHistoricoCliente"></div>
    </div>
  </div>
</div>

<!-- Devolução -->
<div id="modalDevolucao" class="modal">
  <div class="modal-content">
    <span class="close-button" onclick="fecharModal('modalDevolucao')">&times;</span>
    <h3>Realizar Devolução</h3>
    <form id="formDevolucao">
      <div id="devolucaoItens"></div>
      <button type="submit">Confirmar Devolução</button>
    </form>
  </div>
</div>

<!-- Apagar Registro -->
<div id="modalApagarRegistro" class="modal">
  <div class="modal-content">
    <span class="close-button" onclick="fecharModal('modalApagarRegistro')">&times;</span>
    <h3>Apagar Registo</h3>
    <p>Tem a certeza de que quer apagar este registo? Esta ação não pode ser desfeita. Os itens pendentes serão devolvidos ao estoque.</p>
    <form id="formApagar">
      <label for="justificativaApagar">Justificativa (obrigatório):</label>
      <textarea id="justificativaApagar" rows="3" required></textarea>
      <button type="submit">Confirmar e Apagar</button>
    </form>
  </div>
</div>

<!-- Apagar Cliente -->
<div id="modalApagarCliente" class="modal">
  <div class="modal-content">
    <span class="close-button" onclick="fecharModal('modalApagarCliente')">&times;</span>
    <h3>Apagar Cliente</h3>
    <p>Tem a certeza de que quer apagar este cliente? Esta ação não pode ser desfeita. O histórico será arquivado.</p>
    <form id="formApagarCliente">
      <label for="justificativaApagarCliente">Justificativa (obrigatório):</label>
      <textarea id="justificativaApagarCliente" rows="3" required></textarea>
      <button type="submit">Confirmar e Apagar Cliente</button>
    </form>
  </div>
</div>

<!-- Editar Empréstimo -->
<div id="modalEditarEmprestimo" class="modal">
  <div class="modal-content">
    <span class="close-button" onclick="fecharModal('modalEditarEmprestimo')">&times;</span>
    <h3>Editar Empréstimo</h3>

    <input type="hidden" id="editEmprestimoId">

    <div class="grid-2-col">
      <div>
        <label for="editVendedor">Vendedor (do empréstimo):</label>
        <select id="editVendedor" required>
          <option value="">Selecione</option>
          <option>JUNIOR</option>
          <option>ANA CLARA</option>
          <option>CARLOS VITOR</option>
          <option>CID</option>
          <option>ELIEUDA</option>
          <option>CABEÇÃO</option>
        </select>
      </div>
      <div>
        <label for="editDataEmprestimo">Data e Hora:</label>
        <input type="datetime-local" id="editDataEmprestimo" required>
      </div>
    </div>

    <div>
      <label for="editDataDevolucao">Devolução (prevista):</label>
      <input type="date" id="editDataDevolucao" required>
    </div>

    <div class="grid-3-col">
      <div>
        <label for="editMarcaCasco">Marca:</label>
        <select id="editMarcaCasco"></select>
      </div>
      <div>
        <label for="editTamanhoCasco">Tamanho:</label>
        <select id="editTamanhoCasco"></select>
      </div>
      <div>
        <label for="editQtdCasco">Qtd Casco:</label>
        <input type="number" id="editQtdCasco" min="0" value="0">
      </div>
    </div>

    <h4>Caixas</h4>
    <div class="grid-2-col">
      <div>
        <label for="editTipoCaixa">Tipo:</label>
        <select id="editTipoCaixa"></select>
      </div>
      <div>
        <label for="editQtdCaixa">Qtd Caixa:</label>
        <input type="number" id="editQtdCaixa" min="0" value="0">
      </div>
    </div>

    <div class="grid-2-col">
      <div>
        <label for="editAlteradoPor">Alterado por:</label>
        <select id="editAlteradoPor" required>
          <option value="">Selecione</option>
          <option>JUNIOR</option>
          <option>ANA CLARA</option>
          <option>CARLOS VITOR</option>
          <option>CID</option>
          <option>ELIEUDA</option>
          <option>CABEÇÃO</option>
        </select>
      </div>
      <div>
        <label for="justificativaEdicao">Justificativa da alteração:</label>
        <textarea id="justificativaEdicao" rows="3" required placeholder="Explique o motivo (erro, ajuste de quantidade, etc.)"></textarea>
      </div>
    </div>

    <button id="btnSalvarEdicaoEmprestimo">Salvar Alterações</button>
  </div>
</div>

<!-- =========================
     Scripts
========================= -->
<script>
document.addEventListener('DOMContentLoaded', () => {
/* ===================== CONFIG ===================== */
const OFFLINE = false;
const API_URL = '/api';

const VENDEDORES = ["JUNIOR","ANA CLARA","CARLOS VITOR","CID","ELIEUDA","CABEÇÃO"];

const OPCOES_MARCA_CASCO = ["Nenhuma","Brahma","Skol","Bohemia","Budweiser","Original","Devassa","Amstel","Itaipava","Heineken","Stella","Coca Cola"];
const OPCOES_TAMANHO_CASCO = ["Nenhum","300ml","600ml","1L"];
const OPCOES_TIPO_CAIXA = ["Nenhuma","Ambev Azul","Brasil Kirin Amarela","Itaipava Vermelha","Coca Cola LS 1L","Ambev 1L Caixa","Heineken 600ml"];

let clientes = [];
let historico = [];
let historicoHoje = [];
let estoque = [];
let registrosApagados = [];
let notificacoes = [];
let clientesApagados = [];

let clienteAtualParaHistorico = null;
let editClienteId = null;
let registroParaDevolverId = null;
let registroParaApagarId = null;
let clienteParaApagarId = null;

/* ===================== HELPERS ===================== */
const popularSelect = (id, opcoes) => { const s=document.getElementById(id); s.innerHTML=''; opcoes.forEach(v=>s.add(new Option(v,v))); };
const parseDataSeguro = (v) => {
  if (v==null) return null;
  if (v instanceof Date) return isNaN(v)?null:v;
  if (typeof v==='number'){const d=new Date(v);return isNaN(d)?null:d;}
  if (typeof v==='string'){
    const s=v.trim();
    let m=s.match(/^(\d{2})\/(\d{2})\/(\d{4})(?:[ T](\d{2}):(\d{2})(?::(\d{2}))?)?$/);
    if(m){const[,dd,mm,yyyy,hh='00',mi='00',ss='00']=m;const d=new Date(+yyyy,+mm-1,+dd,+hh,+mi,+ss);return isNaN(d)?null:d;}
    m=s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2})(?::(\d{2}))?)?$/);
    if(m){const[,yyyy,mm,dd,hh='00',mi='00',ss='00']=m;const d=new Date(+yyyy,+mm-1,+dd,+hh,+mi,+ss);return isNaN(d)?null:d;}
    const d=new Date(s.replace(' ','T')); return isNaN(d)?null:d;
  }
  return null;
};
const formatarDataHoraBR = (v) => { const d = parseDataSeguro(v); return d ? d.toLocaleString('pt-BR') : '—'; };
const formatarDataBR = (v) => { const d = parseDataSeguro(v); return d ? d.toLocaleDateString('pt-BR') : '—'; };
const formatarHoraBR = (v) => { const d = parseDataSeguro(v); return d ? d.toLocaleTimeString('pt-BR') : '—'; };
const fimDoDia = (d) => { const x = parseDataSeguro(d) || new Date(); x.setHours(23,59,59,999); return x; };
const formatarDataParaInput = (date) => { const d = parseDataSeguro(date) || new Date(); const y=d.getFullYear(), m=(d.getMonth()+1+'').padStart(2,'0'), da=(d.getDate()+'').padStart(2,'0'), hh=(d.getHours()+'').padStart(2,'0'), mi=(d.getMinutes()+'').padStart(2,'0'); return `${y}-${m}-${da}T${hh}:${mi}`; };

function inicializarApp(){
  ['marcaCasco','editMarcaCasco'].forEach(id=>popularSelect(id, OPCOES_MARCA_CASCO));
  ['tamanhoCasco','editTamanhoCasco'].forEach(id=>popularSelect(id, OPCOES_TAMANHO_CASCO));
  ['tipoCaixa','editTipoCaixa'].forEach(id=>popularSelect(id, OPCOES_TIPO_CAIXA));
}
inicializarApp();

/* ===================== LOGIN ===================== */
document.getElementById('formLogin').addEventListener('submit', async e => {
  e.preventDefault();
  const loginErro = document.getElementById('loginErro'); loginErro.textContent='';
  if (OFFLINE){
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('app').style.display='block';
    document.querySelector('.login-watermark')?.style && (document.querySelector('.login-watermark').style.display='none');
    await carregarDadosIniciais(); return;
  }
  try{
    const usuario = document.getElementById('loginUsuario').value.trim().toLowerCase();
    const senha = document.getElementById('loginSenha').value;
    const r = await fetch(`${API_URL}/login`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({usuario,senha})});
    if (r.ok){
      document.getElementById('loginScreen').style.display='none';
      document.getElementById('app').style.display='block';
      document.querySelector('.login-watermark')?.style && (document.querySelector('.login-watermark').style.display='none');
      await carregarDadosIniciais();
    } else {
      const d = await r.json(); loginErro.textContent = d.error || 'Utilizador ou palavra-passe inválidos!';
    }
  }catch(err){ loginErro.textContent='Erro de conexão com o servidor.'; }
});

/* ===================== ABAS ===================== */
const abas = ['Home','Notificacoes','Fisicos','Bares','AdicionarCliente','Estoque','Apagados'];
const mudarAba = (tabId) => {
  abas.forEach(aba=>{
    const el = document.getElementById(`conteudo${aba}`);
    if (el) el.style.display='none';
    document.getElementById(`tab${aba}`).classList.remove('active');
  });
  const active = tabId.replace('tab','');
  const elAtivo = document.getElementById(`conteudo${active}`); if (elAtivo) elAtivo.style.display='block';
  document.getElementById(tabId).classList.add('active');

  if (active==='Home') renderizarHome();
  if (active==='Notificacoes') renderizarNotificacoes();
  if (active==='Fisicos') renderizarClientes('fisico');
  if (active==='Bares') renderizarClientes('bar');
  if (active==='Estoque') renderizarEstoque();
  if (active==='Apagados') renderizarRegistrosApagados();
  if (active==='AdicionarCliente') resetarFormCliente();
};
abas.forEach(aba=> document.getElementById(`tab${aba}`).addEventListener('click', ()=>mudarAba(`tab${aba}`)) );

/* ===================== CARREGAR DADOS ===================== */
async function carregarDadosIniciais(){
  if (OFFLINE){ return; }
  try{
    const [clientesRes, historicoRes, estoqueRes, apagadosRes, hojeRes] = await Promise.all([
      fetch(`${API_URL}/clientes`),
      fetch(`${API_URL}/historico`),
      fetch(`${API_URL}/estoque`),
      fetch(`${API_URL}/registros-apagados`),
      fetch(`${API_URL}/historico/hoje`)
    ]);
    if (![clientesRes, historicoRes, estoqueRes, apagadosRes, hojeRes].every(r=>r.ok)) throw new Error('Falha ao buscar dados');

    clientes = await clientesRes.json();
    historico = await historicoRes.json();
    estoque = await estoqueRes.json();
    registrosApagados = await apagadosRes.json();
    historicoHoje = await hojeRes.json();

    clientes.forEach(c=>{
      const regs = historico.filter(h=>h.cliente_id===c.id);
      c.dividaTotal = regs.reduce((acc,h)=>
        acc + ((h.qtd_casco||0)-(h.qtd_casco_devolvido||0)) + ((h.qtd_caixa||0)-(h.qtd_caixa_devolvido||0))
      ,0);
    });

    mudarAba('tabHome');
  }catch(e){
    console.error(e);
    alert('Não foi possível conectar ao servidor.');
  }
}

/* ===================== RENDER HOME ===================== */
function renderizarHome(){
  const container = document.getElementById('historicoDoDia');
  container.innerHTML='';
  if (!historicoHoje.length) container.innerHTML='<p>Nenhum empréstimo registado hoje.</p>';
  else {
    historicoHoje.forEach(h=>{
      const cascosInfo = h.qtd_casco>0 ? `${h.qtd_casco} Casco(s) (${h.marca_casco})` : '';
      const caixasInfo = h.qtd_caixa>0 ? `${h.qtd_caixa} Caixa(s) (${h.tipo_caixa})` : '';
      const div = document.createElement('div'); div.className='item-lista';
      div.innerHTML = `
        <span><strong>Cliente:</strong> ${h.cliente_nome}</span>
        <span>${cascosInfo} ${caixasInfo}</span>
        <span><small>${formatarDataHoraBR(h.data_emprestimo)}</small></span>
      `;
      container.appendChild(div);
    });
  }
  const totalPendentes = clientes.reduce((acc,c)=>acc+c.dividaTotal,0);
  const clientesComDebitos = clientes.filter(c=>c.dividaTotal>0).length;
  document.getElementById('totalItensPendentes').textContent = totalPendentes;
  document.getElementById('totalClientesComDebitos').textContent = clientesComDebitos;
}

/* ===================== NOTIFICAÇÕES ===================== */
async function gerarNotificacoes(){
  if (OFFLINE){
    notificacoes=[];
    const hojeFim=fimDoDia(new Date()).getTime();
    historico.forEach(h=>{
      const pendC=(h.qtd_casco||0)-(h.qtd_casco_devolvido||0);
      const pendX=(h.qtd_caixa||0)-(h.qtd_caixa_devolvido||0);
      const pend=pendC+pendX;
      if(!h.data_devolucao||pend<=0) return;
      const dev=fimDoDia(h.data_devolucao).getTime();
      if(dev<=hojeFim){
        const cli=clientes.find(c=>c.id===h.cliente_id);
        const dias=Math.ceil((hojeFim-dev)/(24*3600*1000));
        const status=dias<=0?'Vence hoje':`Atrasado ${dias} dia(s)`;
        const res=[];
        if(pendC>0) res.push(`${pendC}x Casco(s) ${h.marca_casco} ${h.tamanho_casco}`);
        if(pendX>0) res.push(`${pendX}x Caixa(s) ${h.tipo_caixa}`);
        notificacoes.push({ clienteId:h.cliente_id, clienteNome:cli?cli.nome:'Desconhecido', dataDevolucao:h.data_devolucao, status, resumo:res.join(' / ') });
      }
    });
  } else {
    const r = await fetch(`${API_URL}/notificacoes`);
    const rows = r.ok? await r.json() : [];
    const porCli = {};
    rows.forEach(h=>{
      const pendC=(h.qtd_casco||0)-(h.qtd_casco_devolvido||0);
      const pendX=(h.qtd_caixa||0)-(h.qtd_caixa_devolvido||0);
      const res=[];
      if(pendC>0) res.push(`${pendC}x Casco(s) ${h.marca_casco} ${h.tamanho_casco}`);
      if(pendX>0) res.push(`${pendX}x Caixa(s) ${h.tipo_caixa}`);
      const status = h.dias_atraso>0 ? `Atrasado ${h.dias_atraso} dia(s)` : 'Vence hoje';
      const base = { clienteId:h.cliente_id, clienteNome:h.cliente_nome, dataDevolucao:h.data_devolucao, status, resumo:res.join(' / ') };
      if (!porCli[h.cliente_id]) porCli[h.cliente_id]=base;
      else porCli[h.cliente_id].resumo += ' | ' + base.resumo;
    });
    notificacoes = Object.values(porCli);
  }
  notificacoes = notificacoes.sort((a,b)=>{
    const A=a.status.startsWith('Atrasado'), B=b.status.startsWith('Atrasado');
    if (A!==B) return A? -1: 1;
    return a.clienteNome.localeCompare(b.clienteNome);
  });
}
async function renderizarNotificacoes(){
  await gerarNotificacoes();
  const box=document.getElementById('listaNotificacoes');
  box.innerHTML='';
  if (!notificacoes.length){ box.innerHTML='<p>Nenhuma notificação no momento.</p>'; return; }
  notificacoes.forEach(n=>{
    const ehAtraso = n.status.startsWith('Atrasado');
    const badgeClass = ehAtraso? 'badge-atraso':'badge-hoje';
    const el = document.createElement('div'); el.className='notificacao';
    el.innerHTML = `
      <div><span class="badge ${badgeClass}">${n.status}</span></div>
      <div><strong>${n.clienteNome}</strong></div>
      <div><small>Devolução: ${formatarDataBR(n.dataDevolucao)}</small></div>
      <div><small>${n.resumo}</small></div>
    `;
    el.onclick = ()=>abrirModal('modalHistoricoCliente', n.clienteId);
    box.appendChild(el);
  });
}

/* ===================== PESQUISAS ===================== */
document.getElementById('pesquisaFisicos').addEventListener('input', (e)=>renderizarClientes('fisico',e.target.value));
document.getElementById('pesquisaBares').addEventListener('input', (e)=>renderizarClientes('bar',e.target.value));

/* ===================== CLIENTES LISTA ===================== */
function renderizarClientes(tipo, filtroNome=''){
  const containerId = tipo==='fisico' ? 'listaClientesFisicos':'listaClientesBares';
  const ctn = document.getElementById(containerId); ctn.innerHTML='';
  const list = clientes.filter(c=>c.tipo===tipo && c.nome.toLowerCase().includes(filtroNome.toLowerCase()))
    .sort((a,b)=>b.dividaTotal - a.dividaTotal);
  if (!list.length){ ctn.innerHTML='<p>Nenhum cliente encontrado.</p>'; return; }
  list.forEach(c=>{
    const div=document.createElement('div'); div.className='item-lista';
    div.innerHTML=`
      <span><strong>${c.nome}</strong><br><small>${c.endereco}, ${c.numero}</small></span>
      <span class="divida">Dívida: ${c.dividaTotal} itens</span>
      <div class="botoes">
        <button class="secondary" onclick="abrirModal('modalHistoricoCliente', ${c.id})">Histórico</button>
        <button class="editar" onclick="editarCliente(${c.id})">Editar</button>
        <button class="apagar-cliente" onclick="abrirModalApagarCliente(${c.id})">Apagar Cliente</button>
      </div>
    `;
    ctn.appendChild(div);
  });
}

/* ===================== ESTOQUE ===================== */
function renderizarEstoque(){
  const ctn=document.getElementById('listaEstoque'); ctn.innerHTML='';
  estoque.sort((a,b)=>a.nome.localeCompare(b.nome)).forEach(item=>{
    ctn.innerHTML += `
      <div class="estoque-item item-lista">
        <span>${item.nome}</span>
        <input type="number" id="estoque-${item.id}" value="${item.quantidade}" onchange="atualizarEstoque('${item.id}')">
      </div>
    `;
  });
}
window.atualizarEstoque = async (itemId) => {
  const input = document.getElementById(`estoque-${itemId}`);
  const quantidade = parseInt(input.value,10);
  if (isNaN(quantidade)) return;
  if (OFFLINE){ const it=estoque.find(i=>i.id===itemId); if(it) it.quantidade=quantidade; return; }
  try{
    const r=await fetch(`${API_URL}/estoque/${itemId}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({quantidade})});
    if(!r.ok) throw new Error('Falha ao atualizar estoque.');
  }catch(e){ alert(e.message); await carregarDadosIniciais(); }
};

/* ===================== CRUD CLIENTE ===================== */
function resetarFormCliente(){
  document.getElementById('formCliente').reset();
  editClienteId=null;
  document.getElementById('formClienteTitulo').textContent='Registar Novo Cliente';
  document.getElementById('btnSalvarCliente').textContent='Guardar Cliente';
  document.getElementById('btnCancelarEdicao').style.display='none';
}
document.getElementById('btnCancelarEdicao').addEventListener('click', resetarFormCliente);

window.editarCliente = (id) => {
  mudarAba('tabAdicionarCliente');
  const c=clientes.find(x=>x.id===id); if(!c) return;
  editClienteId=id;
  document.getElementById('nomeCliente').value=c.nome;
  document.getElementById('tipoCliente').value=c.tipo;
  document.getElementById('enderecoCliente').value=c.endereco;
  document.getElementById('numeroCliente').value=c.numero;
  document.getElementById('telefoneCliente').value=c.telefone||'';
  document.getElementById('formClienteTitulo').textContent='A editar Cliente';
  document.getElementById('btnSalvarCliente').textContent='Atualizar Cliente';
  document.getElementById('btnCancelarEdicao').style.display='block';
  document.getElementById('formCliente').scrollIntoView({behavior:'smooth', block:'start'});
};

document.getElementById('formCliente').addEventListener('submit', async e=>{
  e.preventDefault();
  const payload = {
    nome: document.getElementById('nomeCliente').value.trim(),
    tipo: document.getElementById('tipoCliente').value,
    endereco: document.getElementById('enderecoCliente').value.trim(),
    numero: document.getElementById('numeroCliente').value.trim(),
    telefone: document.getElementById('telefoneCliente').value.trim()
  };
  if (!payload.nome || !payload.tipo || !payload.endereco || !payload.numero) return alert('Todos os campos, exceto telefone, são obrigatórios!');
  if (OFFLINE) return;

  try{
    const url = editClienteId ? `${API_URL}/clientes/${editClienteId}` : `${API_URL}/clientes`;
    const method = editClienteId ? 'PUT':'POST';
    const r = await fetch(url,{method, headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
    if(!r.ok) throw new Error((await r.json()).error || 'Erro no servidor');
    await carregarDadosIniciais();
    mudarAba(payload.tipo==='fisico'?'tabFisicos':'tabBares');
  }catch(e){ alert(`Erro: ${e.message}`); }
});

/* ===================== MODAIS ABRIR/FECHAR ===================== */
window.abrirModal = (modalId, id) => {
  if (modalId==='modalHistoricoCliente'){
    clienteAtualParaHistorico = clientes.find(c=>c.id===id);
    if(!clienteAtualParaHistorico) return;
    document.getElementById('modalTituloCliente').textContent=`Histórico de: ${clienteAtualParaHistorico.nome}`;
    document.getElementById('infoClienteModal').textContent=`Endereço: ${clienteAtualParaHistorico.endereco}, ${clienteAtualParaHistorico.numero}`;
    document.getElementById('dataEmprestimo').value = formatarDataParaInput(new Date());
    const sug=new Date(); sug.setDate(sug.getDate()+7);
    document.getElementById('dataDevolucao').value = (()=>{ const y=sug.getFullYear(), m=(sug.getMonth()+1+'').padStart(2,'0'), d=(sug.getDate()+'').padStart(2,'0'); return `${y}-${m}-${d}`; })();
    renderHistoricoCliente(id);
  }
  if (modalId==='modalDevolucao'){
    registroParaDevolverId=id;
    const reg=historico.find(h=>h.id===id);
    const ctn=document.getElementById('devolucaoItens'); ctn.innerHTML='';
    if(!reg){ ctn.innerHTML='<p>Registro não encontrado.</p>'; }
    else{
      const pendC=(reg.qtd_casco||0)-(reg.qtd_casco_devolvido||0);
      const pendX=(reg.qtd_caixa||0)-(reg.qtd_caixa_devolvido||0);
      if (pendC>0) ctn.innerHTML += `<div><label>Devolver Cascos (${reg.marca_casco} ${reg.tamanho_casco}):</label><input type="number" id="qtdCascoDevolver" value="0" min="0" max="${pendC}"></div>`;
      if (pendX>0) ctn.innerHTML += `<div><label>Devolver Caixas (${reg.tipo_caixa}):</label><input type="number" id="qtdCaixaDevolver" value="0" min="0" max="${pendX}"></div>`;
      if (pendC<=0 && pendX<=0) ctn.innerHTML='<p>Não há itens pendentes para devolver.</p>';
    }
  }
  document.getElementById(modalId).style.display='block';
};
window.fecharModal = (modalId) => document.getElementById(modalId).style.display='none';

/* ===================== NOVO EMPRÉSTIMO ===================== */
document.getElementById('formEmprestimo').addEventListener('submit', async e=>{
  e.preventDefault();
  const vendedor = document.getElementById('vendedorEmprestimo').value.trim();
  const data_emprestimo = document.getElementById('dataEmprestimo').value;
  const data_devolucao = document.getElementById('dataDevolucao').value;
  const marcaCasco = document.getElementById('marcaCasco').value;
  const tamanhoCasco = document.getElementById('tamanhoCasco').value;
  const qtdCasco = parseInt(document.getElementById('qtdCasco').value,10)||0;
  const tipoCaixa = document.getElementById('tipoCaixa').value;
  const qtdCaixa = parseInt(document.getElementById('qtdCaixa').value,10)||0;

  const temCasco = qtdCasco>0 && marcaCasco!=='Nenhuma' && tamanhoCasco!=='Nenhum';
  const temCaixa = qtdCaixa>0 && tipoCaixa!=='Nenhuma';
  if (!temCasco && !temCaixa) return alert('Adicione pelo menos um item.');
  if (!VENDEDORES.includes(vendedor)) return alert('Selecione o vendedor.');

  const payload = {
    cliente_id: clienteAtualParaHistorico.id,
    vendedor,
    marcaCasco, tamanhoCasco, qtdCasco,
    tipoCaixa, qtdCaixa,
    data_emprestimo, data_devolucao
  };

  try{
    const r = await fetch(`${API_URL}/historico`,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
    if (!r.ok) throw new Error('Falha ao guardar empréstimo.');
    await carregarDadosIniciais();
    renderHistoricoCliente(clienteAtualParaHistorico.id);
  }catch(e){ alert(`Erro: ${e.message}`); }
});

/* ===================== DEVOLUÇÃO ===================== */
document.getElementById('formDevolucao').addEventListener('submit', async e=>{
  e.preventDefault();
  const qtdCascoDev=parseInt(document.getElementById('qtdCascoDevolver')?.value||0,10);
  const qtdCaixaDev=parseInt(document.getElementById('qtdCaixaDevolver')?.value||0,10);

  try{
    const r=await fetch(`${API_URL}/historico/devolver/${registroParaDevolverId}`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({qtdCascoDev,qtdCaixaDev})
    });
    if(!r.ok) throw new Error('Falha ao registar devolução.');
    fecharModal('modalDevolucao');
    await carregarDadosIniciais();
    renderHistoricoCliente(clienteAtualParaHistorico.id);
  }catch(e){ alert(`Erro: ${e.message}`); }
});

/* ===================== APAGAR REGISTRO ===================== */
document.getElementById('formApagar').addEventListener('submit', async e=>{
  e.preventDefault();
  const justificativa = document.getElementById('justificativaApagar').value.trim();
  if (!justificativa) return alert('A justificativa é obrigatória.');
  try{
    const r=await fetch(`${API_URL}/historico/${registroParaApagarId}`,{
      method:'DELETE', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({justificativa})
    });
    if(!r.ok) throw new Error((await r.json()).error||'Falha ao apagar registro.');
    fecharModal('modalApagarRegistro');
    document.getElementById('formApagar').reset();
    await carregarDadosIniciais();
    renderHistoricoCliente(clienteAtualParaHistorico.id);
  }catch(e){ alert(`Erro: ${e.message}`); }
});

/* ===================== HISTÓRICO POR CLIENTE ===================== */
function renderHistoricoCliente(clienteId){
  const lista=document.getElementById('listaHistoricoCliente');
  const resumo=document.getElementById('resumoDividaCliente');
  lista.innerHTML='';
  const regs = historico.filter(h=>h.cliente_id===clienteId)
    .sort((a,b)=>(parseDataSeguro(b.data_emprestimo)?.getTime()||0)-(parseDataSeguro(a.data_emprestimo)?.getTime()||0));

  if(!regs.length){ lista.innerHTML='<p>Nenhum empréstimo registado.</p>'; resumo.style.display='none'; return; }

  const divida = regs.reduce((acc,h)=>{
    const pc=(h.qtd_casco||0)-(h.qtd_casco_devolvido||0);
    const px=(h.qtd_caixa||0)-(h.qtd_caixa_devolvido||0);
    if (pc>0) acc[`Casco ${h.marca_casco} ${h.tamanho_casco}`]=(acc[`Casco ${h.marca_casco} ${h.tamanho_casco}`]||0)+pc;
    if (px>0) acc[`Caixa ${h.tipo_caixa}`]=(acc[`Caixa ${h.tipo_caixa}`]||0)+px;
    return acc;
  },{});
  const resumoTexto = Object.entries(divida).map(([item,q])=>`${q}x ${item}`).join(' / ');
  resumo.textContent = resumoTexto ? `Dívida Total: ${resumoTexto}` : 'Nenhuma dívida pendente.';
  resumo.style.display='block';

  regs.forEach(h=>{
    const pc=(h.qtd_casco||0)-(h.qtd_casco_devolvido||0);
    const px=(h.qtd_caixa||0)-(h.qtd_caixa_devolvido||0);
    const temPend=pc>0||px>0;

    const itens=[];
    if(h.qtd_casco>0) itens.push(`${h.qtd_casco} Casco(s) ${h.marca_casco} ${h.tamanho_casco} (Dev: ${h.qtd_casco_devolvido||0})`);
    if(h.qtd_caixa>0) itens.push(`${h.qtd_caixa} Caixa(s) ${h.tipo_caixa} (Dev: ${h.qtd_caixa_devolvido||0})`);

    const div=document.createElement('div');
    div.className='item-lista';
    div.innerHTML=`
      <span>
        <strong>Data: ${formatarDataHoraBR(h.data_emprestimo)}${h.data_devolucao? ' | Devolução: '+formatarDataBR(h.data_devolucao):''}</strong><br>
        <small><strong>Vendedor:</strong> ${h.vendedor||'-'}</small>
        <ul><li>${itens.join('</li><li>')}</li></ul>
      </span>
      <div class="botoes">
        ${temPend? `<button class="devolver" onclick="abrirModal('modalDevolucao', ${h.id})">Devolver</button>`:''}
        <button class="imprimir-recibo" onclick="imprimirRecibo(${h.id})">Recibo</button>
        <button class="editar" onclick="abrirModalEditarEmprestimo(${h.id})">Editar</button>
        <button class="apagar" onclick="registroParaApagarId=${h.id}; abrirModal('modalApagarRegistro')">Apagar</button>
      </div>
    `;
    lista.appendChild(div);
  });
}

/* ===================== EDITAR EMPRÉSTIMO ===================== */
window.abrirModalEditarEmprestimo = (id) => {
  const h = historico.find(x=>x.id===id); if(!h) return;
  document.getElementById('editEmprestimoId').value = id;
  document.getElementById('editVendedor').value = h.vendedor||'';
  document.getElementById('editDataEmprestimo').value = formatarDataParaInput(h.data_emprestimo);
  document.getElementById('editDataDevolucao').value = h.data_devolucao ? h.data_devolucao.slice(0,10) : '';

  document.getElementById('editMarcaCasco').value = OPCOES_MARCA_CASCO.includes(h.marca_casco)? h.marca_casco : 'Nenhuma';
  document.getElementById('editTamanhoCasco').value = OPCOES_TAMANHO_CASCO.includes(h.tamanho_casco)? h.tamanho_casco : 'Nenhum';
  document.getElementById('editQtdCasco').value = h.qtd_casco||0;

  document.getElementById('editTipoCaixa').value = OPCOES_TIPO_CAIXA.includes(h.tipo_caixa)? h.tipo_caixa : 'Nenhuma';
  document.getElementById('editQtdCaixa').value = h.qtd_caixa||0;

  document.getElementById('editAlteradoPor').value = '';

  document.getElementById('modalEditarEmprestimo').style.display='block';
};

document.getElementById('btnSalvarEdicaoEmprestimo').addEventListener('click', async ()=>{
  const id = document.getElementById('editEmprestimoId').value;
  const payload = {
    vendedor: document.getElementById('editVendedor').value,
    data_emprestimo: document.getElementById('editDataEmprestimo').value,
    data_devolucao: document.getElementById('editDataDevolucao').value,
    marca_casco: document.getElementById('editMarcaCasco').value,
    tamanho_casco: document.getElementById('editTamanhoCasco').value,
    qtd_casco: parseInt(document.getElementById('editQtdCasco').value,10)||0,
    tipo_caixa: document.getElementById('editTipoCaixa').value,
    qtd_caixa: parseInt(document.getElementById('editQtdCaixa').value,10)||0,
    justificativa: document.getElementById('justificativaEdicao').value.trim(),
    alterado_por: document.getElementById('editAlteradoPor').value
  };
  if (!payload.justificativa) return alert('Informe a justificativa.');
  if (!payload.alterado_por) return alert('Selecione quem alterou.');
  if (payload.qtd_casco<0 || payload.qtd_caixa<0) return alert('Quantidades inválidas.');

  try{
    const r=await fetch(`${API_URL}/historico/${id}`,{
      method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
    });
    if(!r.ok){ const d=await r.json(); throw new Error(d.error||'Falha ao editar.'); }
    fecharModal('modalEditarEmprestimo');
    await carregarDadosIniciais();
    renderHistoricoCliente(clienteAtualParaHistorico.id);
  }catch(e){ alert(e.message); }
});

/* ===================== WHATSAPP CONSOLIDADO ===================== */
document.getElementById('btnNotificarWhatsapp').addEventListener('click', ()=>{
  if(!clienteAtualParaHistorico) return;
  const telefone = (clienteAtualParaHistorico.telefone||'').replace(/\D/g,'');
  if (!telefone) return alert('Este cliente não possui um número de telefone cadastrado.');

  const regs = historico.filter(h=>h.cliente_id===clienteAtualParaHistorico.id)
    .sort((a,b)=>(parseDataSeguro(a.data_emprestimo)||0)-(parseDataSeguro(b.data_emprestimo)||0));

  const linhasDetalhe=[];
  const somaPorItem={};
  let dataMin=null, dataMax=null;

  regs.forEach(h=>{
    const pendC=(h.qtd_casco||0)-(h.qtd_casco_devolvido||0);
    const pendX=(h.qtd_caixa||0)-(h.qtd_caixa_devolvido||0);
    const dataEmp= formatarDataBR(h.data_emprestimo);

    if (pendC>0){
      const key=`Casco ${h.marca_casco} ${h.tamanho_casco}`;
      linhasDetalhe.push(`- ${pendC}x ${key} (em ${dataEmp})`);
      somaPorItem[key]=(somaPorItem[key]||0)+pendC;
    }
    if (pendX>0){
      const key=`Caixa ${h.tipo_caixa}`;
      linhasDetalhe.push(`- ${pendX}x ${key} (em ${dataEmp})`);
      somaPorItem[key]=(somaPorItem[key]||0)+pendX;
    }

    const d=parseDataSeguro(h.data_emprestimo);
    if (d){
      if(!dataMin || d<dataMin) dataMin=d;
      if(!dataMax || d>dataMax) dataMax=d;
    }
  });

  if (!linhasDetalhe.length) return alert('Este cliente não possui débitos pendentes.');

  const intervaloDatas = dataMin && dataMax
    ? (dataMin.toLocaleDateString('pt-BR')===dataMax.toLocaleDateString('pt-BR')
        ? `(${dataMin.toLocaleDateString('pt-BR')})`
        : `(${dataMin.toLocaleDateString('pt-BR')} até ${dataMax.toLocaleDateString('pt-BR')})`)
    : '';

  const totalConsolidado = Object.entries(somaPorItem)
    .map(([k,q])=>`${q}x ${k}`).join('; ');

  const mensagem = encodeURIComponent(
`Olá ${clienteAtualParaHistorico.nome}, tudo bem?
Da Distribuidora Garcia. Identificamos os seguintes itens pendentes ${intervaloDatas}:

${linhasDetalhe.join('\n')}

Totais: ${totalConsolidado}

Por favor, verifique a possibilidade de devolução. Agradecemos a sua atenção!`
  );
  window.open(`https://wa.me/${telefone}?text=${mensagem}`,'_blank');
});

/* ===================== IMPRESSÃO / RECIBO / RELATÓRIOS ===================== */
/**
 * Perfis de impressão:
 *  - "tx20": térmica 80mm (TX20) com logo e fontes ajustadas
 *  - "termica58": térmica 58mm
 *  - "a4": papel A4
 */
const gerarConteudoImpressao = (titulo, corpo, tipo = "tx20") => {
  const perfis = {
    tx20: {
      pageWidth: "80mm",
      margin: "4mm",
      font: 18,        // base
      lineHeight: 1.45,
      h1: 24,
      h2: 21,
      h3: 19,
      table: 15,       // menor para caber
      th: 16,
      cellPadV: 4,     // padding vertical menor
      cellPadH: 6,
      logoHeight: "210px",
      logoMaxWidth: "74mm"
    },
    termica58: {
      pageWidth: "58mm",
      margin: "4mm",
      font: 17,
      lineHeight: 1.4,
      h1: 22,
      h2: 20,
      h3: 18,
      table: 15,
      th: 16,
      cellPadV: 4,
      cellPadH: 6,
      logoHeight: "160px",
      logoMaxWidth: "54mm"
    },
    a4: {
      pageWidth: "210mm",
      margin: "12mm",
      font: 18,
      lineHeight: 1.6,
      h1: 28,
      h2: 24,
      h3: 22,
      table: 18,
      th: 18,
      cellPadV: 8,
      cellPadH: 10,
      logoHeight: "180px",
      logoMaxWidth: "180px"
    }
  };

  const c = perfis[tipo] || perfis.tx20;

  const tel = "74988433842";
  const endereco = "AV.NOE/PRINCIPAL DA PORTELINHA";

  return `
  <html>
  <head>
    <title>${titulo}</title>
    <meta charset="utf-8">
    <style>
      @page { size: ${c.pageWidth} auto; margin: ${c.margin}; }
      html, body {
        width: ${c.pageWidth};
        margin: 0 auto;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        font-size: ${c.font}px;
        line-height: ${c.lineHeight};
        color: #000;
      }
      h1, h2, h3 { text-align: center; margin: 6px 0; }
      h1 { font-size: ${c.h1}px; }
      h2 { font-size: ${c.h2}px; }
      h3 { font-size: ${c.h3}px; }

      .logo {
        display:block; margin: 0 auto 2px;   /* bem perto */
        height: ${c.logoHeight};
        max-width: ${c.logoMaxWidth};
        object-fit: contain;
        image-rendering: -webkit-optimize-contrast;
      }

      .cabecalho { text-align:center; margin-bottom: 6px; }
      .meta { text-align:center; font-size:${Math.max(c.font-3, 11)}px; white-space:nowrap; }
      .contatos { text-align:center; font-size:${Math.max(c.font-3, 11)}px; margin-top:0; }

      table { width: 100%; border-collapse: collapse; margin-top: 8px; table-layout: fixed; }
      th, td {
        border: 1px solid #000;
        padding: ${c.cellPadV}px ${c.cellPadH}px;
        font-size: ${c.table}px;
        overflow-wrap: anywhere;
        word-break: break-word;
      }
      th { font-size: ${c.th}px; }
      .nowrap{ white-space: nowrap; }

      .assinatura {
        margin-top: 14px; text-align:center;
      }
      .assinatura .linha {
        margin: 18px auto 4px; border-top: 2px solid #000; width: 90%;
      }

      .nota-asterisco{
        margin-top:10px; text-align:center; font-size:${Math.max(c.font-4, 12)}px;
      }

      table, tr, td, th { page-break-inside: avoid; }
      h1, h2, h3, img, p { page-break-inside: avoid; }
    </style>
  </head>
  <body>
    <img src="logo.png" class="logo" alt="Distribuidora Garcia">
    <div class="contatos">Tel.: ${tel} • ${endereco}</div>
    <div class="cabecalho">
      <h1>${titulo}</h1>
      <div class="meta">Data:&nbsp;${new Date().toLocaleDateString('pt-BR')} — Hora:&nbsp;<span class="nowrap">${new Date().toLocaleTimeString('pt-BR')}</span></div>
    </div>
    ${corpo}
    <div class="nota-asterisco">* CADA VASILHAME PERDIDO OU QUEBRADO VAI CUSTAR O VALOR DE R$ 1,00.</div>
  </body>
  </html>`;
};

/* ===================== IMPRESSÃO: RECIBO ===================== */
window.imprimirRecibo = (registroId) => {
  const h = historico.find(x=>x.id===registroId);
  const cli = h ? clientes.find(c=>c.id===h.cliente_id) : null;
  if (!h || !cli) return;

  let itensHtml='';
  if (h.qtd_casco>0) itensHtml += `<tr><td>Casco ${h.marca_casco} ${h.tamanho_casco}</td><td class="nowrap">${h.qtd_casco}</td></tr>`;
  if (h.qtd_caixa>0) itensHtml += `<tr><td>Caixa ${h.tipo_caixa}</td><td class="nowrap">${h.qtd_caixa}</td></tr>`;

  const corpo = `
    <h2>Recibo de Empréstimo</h2>
    <p><strong>Cliente:</strong> ${cli.nome} (${cli.tipo==='fisico'?'F':'B'})</p>
    <p><strong>Endereço:</strong> ${cli.endereco}, ${cli.numero}</p>
    <p><strong>Data do Empréstimo:</strong> <span class="nowrap">${formatarDataHoraBR(h.data_emprestimo)}</span></p>
    <p><strong>Vendedor:</strong> ${h.vendedor || '-'}</p>
    ${h.data_devolucao ? `<p><strong>Devolução Prevista:</strong> <span class="nowrap">${formatarDataBR(h.data_devolucao)}</span></p>`:''}
    <table>
      <colgroup>
        <col style="width:72%">
        <col style="width:28%">
      </colgroup>
      <thead><tr><th>Item</th><th class="nowrap">Quantidade</th></tr></thead>
      <tbody>${itensHtml}</tbody>
    </table>
    <div class="assinatura"><div class="linha"></div>Assinatura do Cliente</div>
  `;
  const win=window.open('','_blank');
  win.document.write(gerarConteudoImpressao('Recibo de Empréstimo', corpo, 'tx20'));
  win.document.close();
  win.onload = ()=> win.print();
};

/* ===================== RELATÓRIO CLIENTE ===================== */
document.getElementById('btnImprimirRelatorioCliente').addEventListener('click', ()=>{
  if(!clienteAtualParaHistorico) return;
  const cli=clienteAtualParaHistorico;
  const regs = historico
    .filter(h=>h.cliente_id===cli.id)
    .sort((a,b)=>(parseDataSeguro(a.data_emprestimo)?.getTime()||0)-(parseDataSeguro(b.data_emprestimo)?.getTime()||0));

  let linhas='';
  if(!regs.length) linhas='<tr><td colspan="6" style="text-align:center;">Sem registros.</td></tr>';
  else regs.forEach(h=>{
    const itens = [
      h.qtd_casco>0 ? `${h.qtd_casco}x Casco ${h.marca_casco} ${h.tamanho_casco} (Dev: ${h.qtd_casco_devolvido||0})`:'',
      h.qtd_caixa>0 ? `${h.qtd_caixa}x Caixa ${h.tipo_caixa} (Dev: ${h.qtd_caixa_devolvido||0})`:''
    ].filter(Boolean).join(' | ');
    linhas += `<tr>
      <td class="nowrap">${formatarDataHoraBR(h.data_emprestimo)}</td>
      <td class="nowrap">${h.data_devolucao?formatarDataBR(h.data_devolucao):'—'}</td>
      <td>${itens||'-'}</td>
      <td class="nowrap">${(h.qtd_casco||0)-(h.qtd_casco_devolvido||0)}</td>
      <td class="nowrap">${(h.qtd_caixa||0)-(h.qtd_caixa_devolvido||0)}</td>
      <td class="nowrap">${h.vendedor||'-'}</td>
    </tr>`;
  });

  const corpo = `
    <h2>Relatório Completo do Cliente</h2>
    <p><strong>Cliente:</strong> ${cli.nome} (${cli.tipo==='fisico'?'F':'B'})</p>
    <p><strong>Endereço:</strong> ${cli.endereco}, ${cli.numero}</p>
    <table>
      <colgroup>
        <col style="width:26%">
        <col style="width:19%">
        <col style="width:33%">
        <col style="width:7%">
        <col style="width:7%">
        <col style="width:8%">
      </colgroup>
      <thead><tr>
        <th class="nowrap">Data Empréstimo</th>
        <th class="nowrap">Devolução Prev.</th>
        <th>Itens</th>
        <th class="nowrap">Cascos</th>
        <th class="nowrap">Caixas</th>
        <th class="nowrap">Vend.</th>
      </tr></thead>
      <tbody>${linhas}</tbody>
    </table>
  `;
  const win=window.open('','_blank');
  win.document.write(gerarConteudoImpressao('Relatório do Cliente', corpo, 'tx20'));
  win.document.close();
  win.onload=()=>win.print();
});

/* ===================== RELATÓRIO GERAL ===================== */
function agregacaoPorGrupoEVolume(pendentesApenas=true){
  const grupos=['Ambev','Brasil Kirin','Grupo Petrópolis','Outros'];
  const acc={
    '300ml': Object.fromEntries(grupos.map(g=>[g,{total:0,marcas:{}}])),
    '600ml': Object.fromEntries(grupos.map(g=>[g,{total:0,marcas:{}}])),
    '1L':    Object.fromEntries(grupos.map(g=>[g,{total:0,marcas:{}}]))
  };
  const grupoDaMarca = (marca)=>{
    if (["Brahma","Skol","Bohemia","Budweiser","Original","Stella","Antarctica"].includes(marca)) return 'Ambev';
    if (["Devassa","Heineken","Amstel"].includes(marca)) return 'Brasil Kirin';
    if (["Itaipava"].includes(marca)) return 'Grupo Petrópolis';
    return 'Outros';
  };
  historico.forEach(h=>{
    const qtdPend=(h.qtd_casco||0)-(h.qtd_casco_devolvido||0);
    if (!h.tamanho_casco || !h.marca_casco) return;
    if (pendentesApenas && qtdPend<=0) return;
    const vol=h.tamanho_casco; if (!acc[vol]) return;
    const g=grupoDaMarca(h.marca_casco);
    acc[vol][g].total += qtdPend;
    acc[vol][g].marcas[h.marca_casco]=(acc[vol][g].marcas[h.marca_casco]||0)+qtdPend;
  });
  return acc;
}
function htmlResumoGrupos(agg){
  const mkLinha=(vol,grupo)=>{
    const d=agg[vol][grupo];
    const brk=Object.entries(d.marcas).sort((a,b)=>b[1]-a[1]).map(([m,q])=>`${m} ${q}`).join(', ');
    return `<tr><td class="nowrap">${vol}</td><td>${grupo}</td><td class="nowrap">${d.total}</td><td>${brk||'-'}</td></tr>`;
  };
  let rows='';
  ['300ml','600ml','1L'].forEach(v=>['Ambev','Brasil Kirin','Grupo Petrópolis','Outros'].forEach(g=>rows+=mkLinha(v,g)));
  return `
    <h3>Resumo de Vasilhames por Grupo e Volume</h3>
    <table>
      <colgroup>
        <col style="width:18%">
        <col style="width:32%">
        <col style="width:12%">
        <col style="width:38%">
      </colgroup>
      <thead><tr><th class="nowrap">Volume</th><th>Grupo</th><th class="nowrap">Total</th><th>Detalhe (marca: quantidade)</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

document.getElementById('btnImprimirExtratoEmprestimos').addEventListener('click', ()=>{
  let corpo = '<h2>Extrato Geral de Dívidas</h2>' + htmlResumoGrupos(agregacaoPorGrupoEVolume(true));
  const cDeb=clientes.filter(c=>c.dividaTotal>0).sort((a,b)=>{
    const pr= t=> t==='fisico'?1:2;
    if (pr(a.tipo)!==pr(b.tipo)) return pr(a.tipo)-pr(b.tipo);
    return a.nome.localeCompare(b.nome);
  });
  if(!cDeb.length) corpo+='<p>Nenhum cliente com débitos pendentes.</p>';
  else cDeb.forEach(c=>{
    corpo+=`<h3>${c.nome} (${c.tipo==='fisico'?'Físico':'Bar'}) — Total: ${c.dividaTotal} itens</h3>`;
    let itensPend='';
    historico.filter(h=>h.cliente_id===c.id).forEach(h=>{
      const pc=(h.qtd_casco||0)-(h.qtd_casco_devolvido||0);
      const px=(h.qtd_caixa||0)-(h.qtd_caixa_devolvido||0);
      const data = formatarDataBR(h.data_emprestimo);
      if (pc>0) itensPend += `<tr><td>Casco ${h.marca_casco} ${h.tamanho_casco}</td><td class="nowrap">${pc}</td><td class="nowrap">${data}</td><td class="nowrap">${h.vendedor||'-'}</td></tr>`;
      if (px>0) itensPend += `<tr><td>Caixa ${h.tipo_caixa}</td><td class="nowrap">${px}</td><td class="nowrap">${data}</td><td class="nowrap">${h.vendedor||'-'}</td></tr>`;
    });
    corpo += `
      <table>
        <colgroup>
          <col style="width:56%">
          <col style="width:12%">
          <col style="width:16%">
          <col style="width:16%">
        </colgroup>
        <thead><tr><th>Item</th><th class="nowrap">Qtd</th><th class="nowrap">Data</th><th class="nowrap">Vendedor</th></tr></thead>
        <tbody>${itensPend || '<tr><td colspan="4">—</td></tr>'}</tbody>
      </table>
    `;
  });
  const win=window.open('','_blank');
  win.document.write(gerarConteudoImpressao('Relatório Geral de Empréstimos', corpo, 'tx20'));
  win.document.close();
  win.onload=()=>win.print();
});

/* ===================== BUSCA POR DATA (resumo) ===================== */
function historicoPorData(dateStr){
  if(!dateStr) return [];
  const d=parseDataSeguro(dateStr); if(!d) return [];
  const y=d.getFullYear(), m=d.getMonth(), da=d.getDate();
  const ini=new Date(y,m,da).getTime(), fim=new Date(y,m,da+1).getTime();
  return historico.map(h=>{
    const t=parseDataSeguro(h.data_emprestimo)?.getTime()||0;
    if (t>=ini && t<fim){
      const cli=clientes.find(c=>c.id===h.cliente_id);
      return {...h, cliente_nome: cli? cli.nome : 'Desconhecido'};
    }
    return null;
  }).filter(Boolean);
}
document.getElementById('btnImprimirResumoDiario').addEventListener('click', ()=> imprimirResumoDeLista(historicoHoje,'Resumo de Hoje'));
document.getElementById('btnImprimirResumoPorData').addEventListener('click', ()=>{
  const data=document.getElementById('dataResumoDia').value;
  imprimirResumoDeLista(historicoPorData(data), `Resumo do Dia (${formatarDataBR(data)})`);
});
function imprimirResumoDeLista(lista, titulo){
  let corpoTabela='';
  if(!lista||!lista.length) corpoTabela='<tr><td colspan="3" style="text-align:center;">Nenhum empréstimo.</td></tr>';
  else lista.forEach(h=>{
    const cascos=h.qtd_casco>0? `${h.qtd_casco} Casco(s) ${h.marca_casco}`:'';
    const caixas=h.qtd_caixa>0? `${h.qtd_caixa} Caixa(s) ${h.tipo_caixa}`:'';
    const hora=formatarHoraBR(h.data_emprestimo);
    corpoTabela += `<tr><td>${h.cliente_nome}</td><td>${cascos} ${caixas}</td><td class="nowrap">${hora}</td></tr>`;
  });
  const corpo = `
    <h2>Empréstimos</h2>
    <table>
      <colgroup>
        <col style="width:48%">
        <col style="width:34%">
        <col style="width:18%">
      </colgroup>
      <thead><tr><th>Cliente</th><th>Itens</th><th class="nowrap">Horário</th></tr></thead>
      <tbody>${corpoTabela}</tbody>
    </table>
  `;
  const win=window.open('','_blank');
  win.document.write(gerarConteudoImpressao(titulo, corpo, 'tx20'));
  win.document.close();
  win.onload=()=>win.print();
}

/* ===================== EVENTOS INICIAIS ===================== */
carregarDadosIniciais();

}); // DOMContentLoaded
</script>
</body>
</html>
