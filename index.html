<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Controle de Cascos e Caixas - Distribuidora Garcia</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* Estilos Gerais */
:root { --cor-principal: #b71c1c; --cor-secundaria: #1976d2; }
body { font-family: Arial, sans-serif; margin: 0; background: #f4f4f4; color: #333; }
.container { max-width: 900px; margin: auto; padding: 10px; }
.box { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
h1,h2,h3,h4 { text-align: center; color: var(--cor-principal); }
h3 { margin-top: 0; }
label { font-weight: bold; display: block; margin-top: 10px; }
input, select, button { width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1em; }
button { background: var(--cor-principal); color: white; font-weight: bold; cursor: pointer; border: none; margin-top: 15px; }
button:hover { opacity: 0.9; }
button.secondary { background: var(--cor-secundaria); }
button.whatsapp { background: #25D366; }
.grid-2-col { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.grid-3-col { display: grid; grid-template-columns: 3fr 2fr 1fr; gap: 15px; }

/* Login */
#loginScreen { padding-top: 50px; }
#loginScreen img { max-width: 200px; display: block; margin: 0 auto 20px; }

/* Navegação por Abas */
.tabs { display: flex; justify-content: space-around; margin-bottom: 15px; background: #ddd; padding: 5px; border-radius: 8px; }
.tabs button { flex: 1; margin: 0 3px; padding: 10px; border-radius: 5px; background: #ccc; font-weight: bold; cursor: pointer; color: #333; border: none; }
.tabs button.active { background: var(--cor-principal); color: white; }

/* Listas e Itens */
.item-lista { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; padding: 10px 0; flex-wrap: wrap; gap: 10px;}
.item-lista:last-child { border-bottom: none; }
.item-lista span { flex: 1; min-width: 150px; }
.item-lista .divida { font-weight: bold; color: var(--cor-principal); }
.item-lista .botoes { display: flex; flex-wrap: wrap; gap: 5px; }
.item-lista button { width: auto; margin: 0; padding: 5px 10px; font-size: 0.9em; }
.item-lista button.editar { background: #f57c00; }
.item-lista button.devolver { background: #388e3c; }
.item-lista button.imprimir-recibo { background: #6a1b9a; }

/* Barra de Pesquisa */
.barra-pesquisa { margin-bottom: 15px; }

/* Home - Top Devedores */
.top-devedores-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.ranking-item { display: flex; align-items: center; gap: 10px; font-size: 1.1em; }
.ranking-pos { font-size: 1.5em; font-weight: bold; color: #999; }
.ranking-divida { font-weight: bold; color: var(--cor-principal); margin-left: auto; }

/* Estoque */
.estoque-item { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px; }
.estoque-item input { width: 100px; text-align: center; }

/* Modal */
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
.modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 700px; border-radius: 8px; position: relative; }
.close-button { color: #aaa; position: absolute; right: 15px; top: 10px; font-size: 28px; font-weight: bold; cursor: pointer; }
.info-cliente-modal { background: #eee; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-weight: bold; }

@media(max-width:600px){
    .item-lista { flex-direction: column; align-items: flex-start; }
    .item-lista .botoes { width: 100%; margin-top: 10px; }
    .grid-2-col, .grid-3-col, .top-devedores-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div class="container">
    <div id="loginScreen">
        <form id="formLogin" class="box">
            <img src="https://placehold.co/400x150/b71c1c/FFFFFF?text=Distribuidora+Garcia" alt="Logo Distribuidora Garcia">
            <h1>Login</h1>
            <label for="loginUsuario">Utilizador:</label>
            <input type="text" id="loginUsuario" required>
            <label for="loginSenha">Palavra-passe:</label>
            <input type="password" id="loginSenha" required>
            <button type="submit">Entrar</button>
            <p id="loginErro" style="color:red;text-align:center;font-weight:bold;"></p>
        </form>
    </div>

    <div id="app" style="display:none;">
        <div class="tabs">
            <button id="tabHome" class="active">Home</button>
            <button id="tabFisicos">Clientes Físicos</button>
            <button id="tabBares">Bares</button>
            <button id="tabEstoque">Estoque</button>
        </div>

        <!-- ECRÃ HOME -->
        <div id="conteudoHome">
            <div class="box">
                <h2>Top Devedores</h2>
                <div class="top-devedores-grid">
                    <div>
                        <h3>Clientes Físicos</h3>
                        <div id="topDevedoresFisicos"></div>
                    </div>
                    <div>
                        <h3>Bares</h3>
                        <div id="topDevedoresBares"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ECRÃ CLIENTES FÍSICOS -->
        <div id="conteudoFisicos" style="display:none;">
            <div class="box">
                <h2>Clientes Físicos</h2>
                <input type="search" id="pesquisaFisicos" class="barra-pesquisa" placeholder="Pesquisar por nome...">
                <div id="listaClientesFisicos"></div>
            </div>
        </div>

        <!-- ECRÃ BARES -->
        <div id="conteudoBares" style="display:none;">
            <div class="box">
                <h2>Bares</h2>
                <input type="search" id="pesquisaBares" class="barra-pesquisa" placeholder="Pesquisar por nome...">
                <div id="listaClientesBares"></div>
            </div>
        </div>

        <!-- ECRÃ ESTOQUE -->
        <div id="conteudoEstoque" style="display:none;">
            <div class="box">
                <h2>Gestão de Estoque</h2>
                <div id="listaEstoque"></div>
            </div>
        </div>

        <!-- Formulário de Cliente (usado por ambas as abas) -->
        <form id="formCliente" class="box">
            <h2 id="formClienteTitulo">Registar Novo Cliente</h2>
            <div class="grid-2-col">
                <div><label for="nomeCliente">Nome:</label><input type="text" id="nomeCliente" required></div>
                <div><label for="tipoCliente">Tipo:</label><select id="tipoCliente" required><option value="">Selecione</option><option value="fisico">Físico</option><option value="bar">Bar</option></select></div>
            </div>
            <div class="grid-2-col">
                <div><label for="enderecoCliente">Endereço:</label><input type="text" id="enderecoCliente" required></div>
                <div><label for="numeroCliente">Número:</label><input type="text" id="numeroCliente" required></div>
            </div>
            <div><label for="telefoneCliente">Telefone (com código do país, ex: 55119...):</label><input type="tel" id="telefoneCliente" placeholder="Ex: 5511987654321"></div>
            <button type="submit" id="btnSalvarCliente">Guardar Cliente</button>
            <button type="button" id="btnCancelarEdicao" class="secondary" style="display:none;">Cancelar Edição</button>
        </form>
    </div>
</div>

<!-- MODAIS -->
<div id="modalHistoricoCliente" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="fecharModal('modalHistoricoCliente')">&times;</span>
        <h2 id="modalTituloCliente">Histórico do Cliente</h2>
        <div id="infoClienteModal" class="info-cliente-modal"></div>
        
        <div class="box">
            <h3>Notificar Cliente via WhatsApp</h3>
            <label for="diasAtraso">Mensagem para dívidas com mais de (dias):</label>
            <input type="number" id="diasAtraso" value="7" min="0">
            <button class="whatsapp" id="btnNotificarWhatsapp">Gerar Mensagem</button>
        </div>

        <form id="formEmprestimo">
            <h3>Registar Novo Empréstimo</h3>
            <div class="grid-3-col">
                <div><label for="marcaCasco">Marca:</label><select id="marcaCasco"></select></div>
                <div><label for="tamanhoCasco">Tamanho:</label><select id="tamanhoCasco"></select></div>
                <div><label for="qtdCasco">Qtd:</label><input type="number" id="qtdCasco" min="0" value="0"></div>
            </div>
            <h4>Caixas</h4>
            <div class="grid-2-col">
                <div><label for="tipoCaixa">Tipo:</label><select id="tipoCaixa"></select></div>
                <div><label for="qtdCaixa">Qtd:</label><input type="number" id="qtdCaixa" min="0" value="0"></div>
            </div>
            <button type="submit">Adicionar Empréstimo</button>
        </form>

        <div class="box">
            <h3>Empréstimos Registados</h3>
            <div id="listaHistoricoCliente"></div>
        </div>
    </div>
</div>

<div id="modalDevolucao" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="fecharModal('modalDevolucao')">&times;</span>
        <h3>Realizar Devolução</h3>
        <form id="formDevolucao">
            <div id="devolucaoItens"></div>
            <button type="submit">Confirmar Devolução</button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

// ======= DADOS E OPÇÕES PRÉ-DEFINIDAS =======
const OPCOES_MARCA_CASCO = ["Nenhuma", "Brahma", "Skol", "Bohemia", "Budweiser", "Original", "Devassa", "Itaipava", "Heineken", "Stella", "Amstel", "Coca Cola"];
const OPCOES_TAMANHO_CASCO = ["Nenhum", "300ml", "600ml", "1L"];
const OPCOES_TIPO_CAIXA = ["Nenhuma", "Ambev Azul", "Brasil Kirin Amarela", "Itaipava Vermelha", "Coca Cola LS 1L", "Ambev 1L Caixa", "Heineken 600ml"];

// ======= VARIÁVEIS GLOBAIS =======
const API_URL = '/api';
let clientes = [];
let historico = [];
let estoque = [];
let clienteAtualParaHistorico = null;
let editClienteId = null; 
let registroParaDevolverId = null;

// ======= FUNÇÕES DE UTILIDADE E INICIALIZAÇÃO =======
const popularSelect = (selectId, opcoes) => {
    const select = document.getElementById(selectId);
    select.innerHTML = '';
    opcoes.forEach(opt => select.add(new Option(opt, opt)));
};

const carregarDadosIniciais = async () => {
    try {
        const [clientesRes, historicoRes, estoqueRes] = await Promise.all([
            fetch(`${API_URL}/clientes`),
            fetch(`${API_URL}/historico`),
            fetch(`${API_URL}/estoque`)
        ]);
        if (!clientesRes.ok || !historicoRes.ok || !estoqueRes.ok) throw new Error('Falha ao buscar dados do servidor.');
        
        clientes = await clientesRes.json();
        historico = await historicoRes.json();
        estoque = await estoqueRes.json();

        mudarAba('tabHome');
    } catch (error) {
        console.error('Erro ao carregar dados iniciais:', error);
        alert('Não foi possível conectar ao servidor.');
    }
};

const inicializarFormularios = () => {
    popularSelect('marcaCasco', OPCOES_MARCA_CASCO);
    popularSelect('tamanhoCasco', OPCOES_TAMANHO_CASCO);
    popularSelect('tipoCaixa', OPCOES_TIPO_CAIXA);
};
inicializarFormularios();

// --- LÓGICA DE LOGIN ---
document.getElementById('formLogin').addEventListener('submit', async e => {
    e.preventDefault();
    const usuario = document.getElementById('loginUsuario').value.trim().toLowerCase();
    const senha = document.getElementById('loginSenha').value;
    const loginErro = document.getElementById('loginErro');
    loginErro.textContent = '';

    try {
        const response = await fetch(`${API_URL}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ usuario, senha })
        });

        if (response.ok) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            carregarDadosIniciais();
        } else {
            const data = await response.json();
            loginErro.textContent = data.error || 'Utilizador ou palavra-passe inválidos!';
        }
    } catch(error) {
        loginErro.textContent = 'Erro de conexão com o servidor.';
    }
});

// ======= NAVEGAÇÃO POR ABAS =======
const abas = ['Home', 'Fisicos', 'Bares', 'Estoque'];
const mudarAba = (tabId) => {
    abas.forEach(aba => {
        document.getElementById(`conteudo${aba}`).style.display = 'none';
        document.getElementById(`tab${aba}`).classList.remove('active');
    });
    const abaAtiva = tabId.replace('tab', '');
    document.getElementById(`conteudo${abaAtiva}`).style.display = 'block';
    document.getElementById(tabId).classList.add('active');

    // Renderiza o conteúdo da aba ativa
    if (abaAtiva === 'Home') renderizarHome();
    if (abaAtiva === 'Fisicos') renderizarClientes('fisico');
    if (abaAtiva === 'Bares') renderizarClientes('bar');
    if (abaAtiva === 'Estoque') renderizarEstoque();
};

abas.forEach(aba => {
    document.getElementById(`tab${aba}`).addEventListener('click', () => mudarAba(`tab${aba}`));
});

// ======= RENDERIZAÇÃO DAS SECÇÕES =======

const renderizarHome = () => {
    const topFisicos = clientes
        .filter(c => c.tipo === 'fisico' && c.dividaTotal > 0)
        .sort((a, b) => b.dividaTotal - a.dividaTotal)
        .slice(0, 5);
    
    const topBares = clientes
        .filter(c => c.tipo === 'bar' && c.dividaTotal > 0)
        .sort((a, b) => b.dividaTotal - a.dividaTotal)
        .slice(0, 5);

    const renderRanking = (containerId, lista) => {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        if (lista.length === 0) {
            container.innerHTML = '<p>Nenhum devedor encontrado.</p>';
            return;
        }
        lista.forEach((cliente, index) => {
            container.innerHTML += `
                <div class="ranking-item">
                    <span class="ranking-pos">#${index + 1}</span>
                    <span>${cliente.nome}</span>
                    <span class="ranking-divida">${cliente.dividaTotal} itens</span>
                </div>
            `;
        });
    };
    
    renderRanking('topDevedoresFisicos', topFisicos);
    renderRanking('topDevedoresBares', topBares);
};

const renderizarClientes = (tipo, filtroNome = '') => {
    const containerId = tipo === 'fisico' ? 'listaClientesFisicos' : 'listaClientesBares';
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    const filtrados = clientes
        .filter(c => c.tipo === tipo && c.nome.toLowerCase().includes(filtroNome.toLowerCase()))
        .sort((a, b) => b.dividaTotal - a.dividaTotal);

    if (filtrados.length === 0) {
        container.innerHTML = '<p>Nenhum cliente encontrado.</p>';
        return;
    }

    filtrados.forEach(c => {
        const div = document.createElement('div');
        div.className = 'item-lista';
        div.innerHTML = `
            <span><strong>${c.nome}</strong><br><small>${c.endereco}, ${c.numero}</small></span>
            <span class="divida">Dívida: ${c.dividaTotal} itens</span>
            <div class="botoes">
                <button class="secondary" onclick="abrirModal('modalHistoricoCliente', ${c.id})">Histórico</button>
                <button class="editar" onclick="editarCliente(${c.id})">Editar</button>
            </div>`;
        container.appendChild(div);
    });
};

const renderizarEstoque = () => {
    const container = document.getElementById('listaEstoque');
    container.innerHTML = '';
    estoque.forEach(item => {
        container.innerHTML += `
            <div class="estoque-item item-lista">
                <span>${item.nome}</span>
                <input type="number" id="estoque-${item.id}" value="${item.quantidade}" onchange="atualizarEstoque('${item.id}')">
            </div>
        `;
    });
};

// ======= LÓGICA DE PESQUISA =======
document.getElementById('pesquisaFisicos').addEventListener('input', (e) => renderizarClientes('fisico', e.target.value));
document.getElementById('pesquisaBares').addEventListener('input', (e) => renderizarClientes('bar', e.target.value));

// ======= GESTÃO DE CLIENTES =======
const resetarFormCliente = () => {
    document.getElementById('formCliente').reset();
    editClienteId = null;
    document.getElementById('formClienteTitulo').textContent = 'Registar Novo Cliente';
    document.getElementById('btnSalvarCliente').textContent = 'Guardar Cliente';
    document.getElementById('btnCancelarEdicao').style.display = 'none';
};

document.getElementById('btnCancelarEdicao').addEventListener('click', resetarFormCliente);

window.editarCliente = (id) => {
    const cliente = clientes.find(c => c.id === id);
    if (!cliente) return;
    editClienteId = id;
    document.getElementById('nomeCliente').value = cliente.nome;
    document.getElementById('tipoCliente').value = cliente.tipo;
    document.getElementById('enderecoCliente').value = cliente.endereco;
    document.getElementById('numeroCliente').value = cliente.numero;
    document.getElementById('telefoneCliente').value = cliente.telefone || '';
    document.getElementById('formClienteTitulo').textContent = 'A editar Cliente';
    document.getElementById('btnSalvarCliente').textContent = 'Atualizar Cliente';
    document.getElementById('btnCancelarEdicao').style.display = 'block';
    document.getElementById('formCliente').scrollIntoView({ behavior: 'smooth' });
};

document.getElementById('formCliente').addEventListener('submit', async e => {
    e.preventDefault();
    const clienteData = {
        nome: document.getElementById('nomeCliente').value.trim(),
        tipo: document.getElementById('tipoCliente').value,
        endereco: document.getElementById('enderecoCliente').value.trim(),
        numero: document.getElementById('numeroCliente').value.trim(),
        telefone: document.getElementById('telefoneCliente').value.trim()
    };
    if (!clienteData.nome || !clienteData.tipo || !clienteData.endereco || !clienteData.numero) return alert("Todos os campos, exceto telefone, são obrigatórios!");

    try {
        const url = editClienteId ? `${API_URL}/clientes/${editClienteId}` : `${API_URL}/clientes`;
        const method = editClienteId ? 'PUT' : 'POST';
        const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(clienteData)
        });
        if (!response.ok) throw new Error((await response.json()).error || 'Erro no servidor');
        
        await carregarDadosIniciais();
        resetarFormCliente();
    } catch(error) {
        alert(`Erro: ${error.message}`);
    }
});

// ======= GESTÃO DE ESTOQUE =======
window.atualizarEstoque = async (itemId) => {
    const input = document.getElementById(`estoque-${itemId}`);
    const quantidade = parseInt(input.value, 10);
    if (isNaN(quantidade)) return;

    try {
        const response = await fetch(`${API_URL}/estoque/${itemId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ quantidade })
        });
        if (!response.ok) throw new Error('Falha ao atualizar estoque.');
        // Atualiza o valor localmente para feedback imediato
        const itemEstoque = estoque.find(i => i.id === itemId);
        if (itemEstoque) itemEstoque.quantidade = quantidade;
    } catch (error) {
        alert(error.message);
        carregarDadosIniciais(); // Recarrega para reverter
    }
};


// ======= MODAIS, EMPRÉSTIMOS E DEVOLUÇÕES =======
// (Lógica interna dos modais, empréstimos, devoluções, etc. continua aqui)
// ...
window.abrirModal = (modalId, id) => {
    if (modalId === 'modalHistoricoCliente') {
        clienteAtualParaHistorico = clientes.find(c => c.id === id);
        if (!clienteAtualParaHistorico) return;
        
        document.getElementById('modalTituloCliente').textContent = `Histórico de: ${clienteAtualParaHistorico.nome}`;
        document.getElementById('infoClienteModal').textContent = `Endereço: ${clienteAtualParaHistorico.endereco}, ${clienteAtualParaHistorico.numero}`;
        renderHistoricoCliente(id);
    }
    if (modalId === 'modalDevolucao') {
        registroParaDevolverId = id;
        const registro = historico.find(h => h.id === registroParaDevolverId);
        const container = document.getElementById('devolucaoItens');
        container.innerHTML = '';
        const cascosPendentes = (registro.qtd_casco || 0) - (registro.qtd_casco_devolvido || 0);
        const caixasPendentes = (registro.qtd_caixa || 0) - (registro.qtd_caixa_devolvido || 0);

        if(cascosPendentes > 0) container.innerHTML += `<div><label>Devolver Cascos (${registro.marca_casco} ${registro.tamanho_casco}):</label><input type="number" id="qtdCascoDevolver" value="0" min="0" max="${cascosPendentes}"></div>`;
        if(caixasPendentes > 0) container.innerHTML += `<div><label>Devolver Caixas (${registro.tipo_caixa}):</label><input type="number" id="qtdCaixaDevolver" value="0" min="0" max="${caixasPendentes}"></div>`;
    }
    document.getElementById(modalId).style.display = 'block';
};

window.fecharModal = (modalId) => {
    document.getElementById(modalId).style.display = 'none';
};

document.getElementById('formEmprestimo').addEventListener('submit', async e => {
    e.preventDefault();
    const novoRegistro = {
        cliente_id: clienteAtualParaHistorico.id,
        marcaCasco: document.getElementById('marcaCasco').value,
        tamanhoCasco: document.getElementById('tamanhoCasco').value,
        qtdCasco: parseInt(document.getElementById('qtdCasco').value, 10) || 0,
        tipoCaixa: document.getElementById('tipoCaixa').value,
        qtdCaixa: parseInt(document.getElementById('qtdCaixa').value, 10) || 0,
    };
    const temCasco = novoRegistro.qtdCasco > 0 && novoRegistro.marcaCasco !== 'Nenhuma' && novoRegistro.tamanhoCasco !== 'Nenhum';
    const temCaixa = novoRegistro.qtdCaixa > 0 && novoRegistro.tipoCaixa !== 'Nenhuma';
    if (!temCasco && !temCaixa) return alert("Adicione pelo menos um item.");
    
    try {
        const response = await fetch(`${API_URL}/historico`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(novoRegistro)
        });
        if (!response.ok) throw new Error('Falha ao guardar empréstimo.');
        await carregarDadosIniciais();
        document.getElementById('formEmprestimo').reset();
        renderHistoricoCliente(clienteAtualParaHistorico.id);
    } catch (error) {
        alert(`Erro: ${error.message}`);
    }
});

document.getElementById('formDevolucao').addEventListener('submit', async e => {
    e.preventDefault();
    const qtdCascoDev = parseInt(document.getElementById('qtdCascoDevolver')?.value || 0, 10);
    const qtdCaixaDev = parseInt(document.getElementById('qtdCaixaDevolver')?.value || 0, 10);
    try {
        const response = await fetch(`${API_URL}/historico/devolver/${registroParaDevolverId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ qtdCascoDev, qtdCaixaDev })
        });
        if (!response.ok) throw new Error('Falha ao registar devolução.');
        await carregarDadosIniciais();
        fecharModal('modalDevolucao');
        renderHistoricoCliente(clienteAtualParaHistorico.id);
    } catch (error) {
        alert(`Erro: ${error.message}`);
    }
});

const renderHistoricoCliente = (clienteId) => {
    const lista = document.getElementById('listaHistoricoCliente');
    lista.innerHTML = '';
    const registros = historico.filter(h => h.cliente_id === clienteId).sort((a, b) => new Date(b.data_emprestimo) - new Date(a.data_emprestimo));
    if(registros.length === 0) lista.innerHTML = '<p>Nenhum empréstimo registado.</p>';

    registros.forEach(h => {
        const cascosPendentes = (h.qtd_casco || 0) - (h.qtd_casco_devolvido || 0);
        const caixasPendentes = (h.qtd_caixa || 0) - (h.qtd_caixa_devolvido || 0);
        const totalPendente = cascosPendentes + caixasPendentes;
        
        let statusClass = 'status-ok';
        let statusText = 'OK';
        if (totalPendente > 0) {
            const totalDevolvido = (h.qtd_casco_devolvido || 0) + (h.qtd_caixa_devolvido || 0);
            statusClass = totalDevolvido > 0 ? 'status-parcial' : 'status-pendente';
            statusText = totalDevolvido > 0 ? 'Parcial' : 'Pendente';
        }

        const cascosInfo = h.qtd_casco > 0 ? `Cascos: ${h.qtd_casco_devolvido}/${h.qtd_casco} (${h.marca_casco})` : '';
        const caixasInfo = h.qtd_caixa > 0 ? `Caixas: ${h.qtd_caixa_devolvido}/${h.qtd_caixa} (${h.tipo_caixa})` : '';

        const div = document.createElement('div');
        div.className = 'item-lista';
        div.innerHTML = `
            <span><strong>Empréstimo:</strong> ${h.data_emprestimo}<br><span class="${statusClass}">${statusText}</span></span>
            <span>${cascosInfo}<br>${caixasInfo}</span>
            <div class="botoes">
                ${totalPendente > 0 ? `<button class="devolver" onclick="abrirModal('modalDevolucao', ${h.id})">Devolver</button>` : ''}
                <button class="imprimir-recibo" onclick="imprimirRecibo(${h.id})">Imprimir Recibo</button>
            </div>
        `;
        lista.appendChild(div);
    });
};

// ======= WHATSAPP =======
document.getElementById('btnNotificarWhatsapp').addEventListener('click', () => {
    if (!clienteAtualParaHistorico || !clienteAtualParaHistorico.telefone) {
        return alert('Este cliente não tem um número de telefone registado.');
    }
    const diasAtraso = parseInt(document.getElementById('diasAtraso').value, 10);
    const agora = new Date();
    let itensPendentesMsg = '';

    historico
        .filter(h => h.cliente_id === clienteAtualParaHistorico.id)
        .forEach(h => {
            const dataEmprestimo = new Date(h.data_emprestimo.split(', ')[0].split('/').reverse().join('-') + 'T' + h.data_emprestimo.split(', ')[1]);
            const diffDias = Math.floor((agora - dataEmprestimo) / (1000 * 60 * 60 * 24));

            if (diffDias >= diasAtraso) {
                const cascosPendentes = (h.qtd_casco || 0) - (h.qtd_casco_devolvido || 0);
                const caixasPendentes = (h.qtd_caixa || 0) - (h.qtd_caixa_devolvido || 0);
                if (cascosPendentes > 0) itensPendentesMsg += `\\n- ${cascosPendentes} Casco(s) (${h.marca_casco})`;
                if (caixasPendentes > 0) itensPendentesMsg += `\\n- ${caixasPendentes} Caixa(s) (${h.tipo_caixa})`;
            }
        });
    
    if (!itensPendentesMsg) {
        return alert(`Este cliente não tem itens pendentes há mais de ${diasAtraso} dias.`);
    }

    const mensagem = `Olá, ${clienteAtualParaHistorico.nome}. Da Distribuidora Garcia, notamos que há alguns itens pendentes para devolução há mais de ${diasAtraso} dias:\\n${itensPendentesMsg}\\n\\nPor favor, entre em contacto para agendar a devolução. Obrigado!`;
    const urlWhatsapp = `https://wa.me/${clienteAtualParaHistorico.telefone}?text=${encodeURIComponent(mensagem)}`;
    window.open(urlWhatsapp, '_blank');
});


// ======= IMPRESSÃO =======
// (A lógica de impressão permanece a mesma)
// ...
function printHelper(printContents, title, isReceipt = false) {
    const printWindow = window.open('', '_blank');
    let styles = `body { font-family: Arial, sans-serif; } h1, h2, h3 { text-align: center; margin: 5px 0; } p { margin: 2px 0; } ul { list-style-position: inside; padding-left: 0; } .relatorio-pronto { width: 100%; } .relatorio-pronto .item-relatorio { border-bottom: 1px dashed #666; padding: 10px 0; page-break-inside: avoid; }`;
    if (isReceipt) {
        styles += `@page { size: 80mm; margin: 2mm; } body { font-family: 'Courier New', Courier, monospace; width: 80mm; font-size: 10pt; } .itens { border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 5px 0; margin: 10px 0; } .footer { text-align: center; margin-top: 15px; }`;
    }
    printWindow.document.write(`<html><head><title>${title}</title><style>${styles}</style></head><body>${printContents}</body></html>`);
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
}
window.imprimirRecibo = (historicoId) => {
    const registro = historico.find(h => h.id === historicoId);
    const cliente = clientes.find(c => c.id === registro.cliente_id);
    let itensHtml = '';
    if (registro.qtd_casco > 0) itensHtml += `<p>${registro.qtd_casco}x Casco ${registro.marca_casco} ${registro.tamanho_casco}</p>`;
    if (registro.qtd_caixa > 0) itensHtml += `<p>${registro.qtd_caixa}x Caixa ${registro.tipo_caixa}</p>`;
    const htmlRecibo = `<div><h2>Distribuidora Garcia</h2><h3>Recibo de Empréstimo</h3><p>--------------------------------</p><p><strong>Data:</strong> ${registro.data_emprestimo}</p><p><strong>Cliente:</strong> ${cliente.nome}</p><p><strong>Endereço:</strong> ${cliente.endereco}, ${cliente.numero}</p><div class="itens">${itensHtml}</div><p class="footer">Obrigado pela preferência!</p><p class="footer">.</p></div>`;
    printHelper(htmlRecibo, 'Recibo de Empréstimo', true);
};

});
</script>
</body>
</html>
