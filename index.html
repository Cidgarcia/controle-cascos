<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Controle de Cascos e Caixas - Distribuidora Garcia</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* Estilos Gerais */
:root { --cor-principal: #b71c1c; --cor-secundaria: #1976d2; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #f0f2f5; color: #333; }
.container { max-width: 1000px; margin: auto; padding: 10px; }
.box { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
h1,h2,h3,h4 { text-align: center; color: var(--cor-principal); margin-top: 0; }
h2 { margin-bottom: 20px; }
label { font-weight: 600; display: block; margin-top: 15px; margin-bottom: 5px; }
input, select, button, textarea { width: 100%; padding: 12px; margin-top: 5px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1em; }
button { background: var(--cor-principal); color: white; font-weight: bold; cursor: pointer; border: none; margin-top: 20px; transition: background-color 0.2s; }
button:hover { opacity: 0.9; }
button.secondary { background: var(--cor-secundaria); }
button.whatsapp { background: #25D366; }
.grid-2-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.grid-3-col { display: grid; grid-template-columns: 3fr 2fr 1fr; gap: 15px; }

/* Header e Logo */
.header { display: flex; align-items: center; padding: 10px; background: white; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); }
.header img { height: 50px; }

/* Login */
#loginScreen { padding-top: 50px; }
#loginScreen .box { max-width: 400px; margin: auto; }
#loginScreen img { max-width: 250px; display: block; margin: 0 auto 20px; }

/* Navega√ß√£o por Abas */
.tabs { display: flex; flex-wrap: wrap; justify-content: space-around; margin-bottom: 20px; background: #e9ecef; padding: 5px; border-radius: 8px; }
.tabs button { flex: 1; min-width: 120px; margin: 5px; padding: 12px; border-radius: 6px; background: transparent; font-weight: 600; cursor: pointer; color: #495057; border: none; transition: all 0.2s; }
.tabs button.active { background: var(--cor-principal); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

/* Listas e Itens */
.item-lista { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e9ecef; padding: 15px 5px; flex-wrap: wrap; gap: 10px;}
.item-lista:last-child { border-bottom: none; }
.item-lista span { flex: 1; min-width: 150px; }
.item-lista .divida { font-weight: bold; color: var(--cor-principal); }
.item-lista .botoes { display: flex; flex-wrap: wrap; gap: 5px; }
.item-lista button { width: auto; margin: 0; padding: 8px 12px; font-size: 0.9em; }
.item-lista button.editar { background: #f57c00; }
.item-lista button.devolver { background: #388e3c; }
.item-lista button.imprimir-recibo { background: #6a1b9a; }
.item-lista button.apagar { background: #444; }

/* Barra de Pesquisa */
.barra-pesquisa { margin-bottom: 20px; padding: 12px; }

/* Home */
.home-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
.home-grid .box { flex-grow: 1; text-align: center; }
.home-grid .stat-number { font-size: 2.5em; font-weight: bold; color: var(--cor-principal); }

/* Estoque */
.estoque-item { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px; }
.estoque-item input { width: 100px; text-align: center; }

/* Registos Apagados */
.apagado-item { background: #f9f9f9; border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 5px; }
.apagado-item p { margin: 5px 0; }
.apagado-item strong { color: #555; }

/* Modal */
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
.modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 700px; border-radius: 8px; position: relative; animation: slide-down 0.3s ease-out; }
@keyframes slide-down { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.close-button { color: #aaa; position: absolute; right: 15px; top: 10px; font-size: 28px; font-weight: bold; cursor: pointer; }
.info-cliente-modal { background: #e9ecef; padding: 15px; border-radius: 6px; margin-bottom: 20px; font-weight: bold; }
.resumo-divida-cliente { background: var(--cor-principal); color: white; padding: 10px; border-radius: 6px; margin-bottom: 20px; text-align: center; font-weight: bold;}


@media(max-width:768px){
    .grid-2-col, .home-grid { grid-template-columns: 1fr; }
    .item-lista { flex-direction: column; align-items: flex-start; }
    .item-lista .botoes { width: 100%; margin-top: 10px; }
}
</style>
</head>
<body>

<div class="container">
    <div id="loginScreen">
        <div class="box">
            <img src="logo.png" alt="Logo Distribuidora Garcia">
            <h1>Login</h1>
            <form id="formLogin">
                <label for="loginUsuario">Utilizador:</label>
                <input type="text" id="loginUsuario" required>
                <label for="loginSenha">Palavra-passe:</label>
                <input type="password" id="loginSenha" required>
                <button type="submit">Entrar</button>
                <p id="loginErro" style="color:red;text-align:center;font-weight:bold;"></p>
            </form>
        </div>
    </div>

    <div id="app" style="display:none;">
        <div class="header">
            <img src="logo.png" alt="Logo Distribuidora Garcia">
        </div>
        <div class="tabs">
            <button id="tabHome" class="active">Home</button>
            <button id="tabFisicos">Clientes F√≠sicos</button>
            <button id="tabBares">Bares</button>
            <button id="tabAdicionarCliente">Adicionar Cliente</button>
            <button id="tabEstoque">Estoque</button>
            <button id="tabApagados">Registos Apagados</button>
        </div>

        <div id="conteudoHome">
             <div class="box home-grid">
                <div class="box">
                    <h3>Total de Itens Pendentes</h3>
                    <p id="totalItensPendentes" class="stat-number">0</p>
                </div>
                <div class="box">
                    <h3>Clientes com D√©bitos</h3>
                    <p id="totalClientesComDebitos" class="stat-number">0</p>
                </div>
            </div>
            <div class="box">
                <h2>Relat√≥rios e Extratos</h2>
                <div class="grid-2-col">
                    <button id="btnImprimirResumoDiario">Imprimir Resumo do Dia</button>
                    <button id="btnImprimirExtratoEmprestimos" class="secondary">Imprimir Extrato Geral de Empr√©stimos</button>
                </div>
            </div>
            <div class="box">
                <h2>Hist√≥rico de Empr√©stimos do Dia</h2>
                <div id="historicoDoDia"></div>
            </div>
        </div>

        <div id="conteudoFisicos" style="display:none;">
            <div class="box">
                <h2>Clientes F√≠sicos</h2>
                <input type="search" id="pesquisaFisicos" class="barra-pesquisa" placeholder="Pesquisar por nome...">
                <div id="listaClientesFisicos"></div>
            </div>
        </div>
        <div id="conteudoBares" style="display:none;">
            <div class="box">
                <h2>Bares</h2>
                <input type="search" id="pesquisaBares" class="barra-pesquisa" placeholder="Pesquisar por nome...">
                <div id="listaClientesBares"></div>
            </div>
        </div>
        
        <div id="conteudoAdicionarCliente" style="display:none;">
            <form id="formCliente" class="box">
                <h2 id="formClienteTitulo">Registar Novo Cliente</h2>
                <div class="grid-2-col">
                    <div><label for="nomeCliente">Nome:</label><input type="text" id="nomeCliente" required></div>
                    <div><label for="tipoCliente">Tipo:</label><select id="tipoCliente" required><option value="">Selecione</option><option value="fisico">F√≠sico</option><option value="bar">Bar</option></select></div>
                </div>
                <div class="grid-2-col">
                    <div><label for="enderecoCliente">Endere√ßo:</label><input type="text" id="enderecoCliente" required></div>
                    <div><label for="numeroCliente">N√∫mero:</label><input type="text" id="numeroCliente" required></div>
                </div>
                <div><label for="telefoneCliente">Telefone (com c√≥digo do pa√≠s, ex: 55119...):</label><input type="tel" id="telefoneCliente" placeholder="Ex: 5511987654321"></div>
                <button type="submit" id="btnSalvarCliente">Guardar Cliente</button>
                <button type="button" id="btnCancelarEdicao" class="secondary" style="display:none;">Cancelar Edi√ß√£o</button>
            </form>
        </div>

        <div id="conteudoEstoque" style="display:none;">
            <div class="box">
                <h2>Gest√£o de Estoque</h2>
                <div id="listaEstoque"></div>
                <button id="btnImprimirExtratoEstoque" class="secondary">Imprimir Extrato de Estoque</button>
            </div>
        </div>

        <div id="conteudoApagados" style="display:none;">
            <div class="box">
                <h2>Registos de Empr√©stimo Apagados</h2>
                <div id="listaRegistrosApagados"></div>
            </div>
        </div>
    </div>
</div>

<div id="modalHistoricoCliente" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="fecharModal('modalHistoricoCliente')">&times;</span>
        <h2 id="modalTituloCliente">Hist√≥rico do Cliente</h2>
        <div id="infoClienteModal" class="info-cliente-modal"></div>
        <div id="resumoDividaCliente" class="resumo-divida-cliente"></div>
        
        <div class="box">
            <h3>Notificar Cliente via WhatsApp</h3>
            <button class="whatsapp" id="btnNotificarWhatsapp">Gerar Mensagem de Cobran√ßa</button>
        </div>

        <form id="formEmprestimo">
            <h3>Registar Novo Empr√©stimo</h3>
            
            <div><label for="dataEmprestimo">Data e Hora do Empr√©stimo:</label><input type="datetime-local" id="dataEmprestimo" required></div>
            
            <div class="grid-3-col">
                <div><label for="marcaCasco">Marca:</label><select id="marcaCasco"></select></div>
                <div><label for="tamanhoCasco">Tamanho:</label><select id="tamanhoCasco"></select></div>
                <div><label for="qtdCasco">Qtd:</label><input type="number" id="qtdCasco" min="0" value="0"></div>
            </div>
            <h4>Caixas</h4>
            <div class="grid-2-col">
                <div><label for="tipoCaixa">Tipo:</label><select id="tipoCaixa"></select></div>
                <div><label for="qtdCaixa">Qtd:</label><input type="number" id="qtdCaixa" min="0" value="0"></div>
            </div>
            <button type="submit">Adicionar Empr√©stimo</button>
        </form>

        <div class="box">
            <h3>Empr√©stimos Registados</h3>
            <div id="listaHistoricoCliente"></div>
        </div>
    </div>
</div>

<div id="modalDevolucao" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="fecharModal('modalDevolucao')">&times;</span>
        <h3>Realizar Devolu√ß√£o</h3>
        <form id="formDevolucao">
            <div id="devolucaoItens"></div>
            <button type="submit">Confirmar Devolu√ß√£o</button>
        </form>
    </div>
</div>

<div id="modalApagarRegistro" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="fecharModal('modalApagarRegistro')">&times;</span>
        <h3>Apagar Registo</h3>
        <p>Tem a certeza de que quer apagar este registo? Esta a√ß√£o n√£o pode ser desfeita. Os itens pendentes ser√£o devolvidos ao estoque.</p>
        <form id="formApagar">
            <label for="justificativaApagar">Justificativa (obrigat√≥rio):</label>
            <textarea id="justificativaApagar" rows="3" required></textarea>
            <button type="submit">Confirmar e Apagar</button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

// ======= DADOS E OP√á√ïES PR√â-DEFINIDAS =======
const OPCOES_MARCA_CASCO = ["Nenhuma", "Brahma", "Skol", "Bohemia", "Budweiser", "Original", "Devassa", "Amstel", "Itaipava", "Heineken", "Stella", "Coca Cola"];
const OPCOES_TAMANHO_CASCO = ["Nenhum", "300ml", "600ml", "1L"];
const OPCOES_TIPO_CAIXA = ["Nenhuma", "Ambev Azul", "Brasil Kirin Amarela", "Itaipava Vermelha", "Coca Cola LS 1L", "Ambev 1L Caixa", "Heineken 600ml"];

// ======= VARI√ÅVEIS GLOBAIS =======
const API_URL = '/api';
let clientes = [];
let historico = [];
let historicoHoje = [];
let estoque = [];
let registrosApagados = [];
let clienteAtualParaHistorico = null;
let editClienteId = null; 
let registroParaDevolverId = null;
let registroParaApagarId = null;

// ======= FUN√á√ïES DE UTILIDADE E INICIALIZA√á√ÉO =======
const popularSelect = (selectId, opcoes) => {
    const select = document.getElementById(selectId);
    select.innerHTML = '';
    opcoes.forEach(opt => select.add(new Option(opt, opt)));
};

const carregarDadosIniciais = async () => {
    try {
        const [clientesRes, historicoRes, estoqueRes, apagadosRes, hojeRes] = await Promise.all([
            fetch(`${API_URL}/clientes`),
            fetch(`${API_URL}/historico`),
            fetch(`${API_URL}/estoque`),
            fetch(`${API_URL}/registros-apagados`),
            fetch(`${API_URL}/historico/hoje`)
        ]);
        if (!clientesRes.ok || !historicoRes.ok || !estoqueRes.ok || !apagadosRes.ok || !hojeRes.ok) throw new Error('Falha ao buscar dados do servidor.');
        
        clientes = await clientesRes.json();
        historico = await historicoRes.json();
        estoque = await estoqueRes.json();
        registrosApagados = await apagadosRes.json();
        historicoHoje = await hojeRes.json();

        // Adiciona a d√≠vida total a cada cliente para facilitar a ordena√ß√£o e exibi√ß√£o
        clientes.forEach(c => {
            const registrosCliente = historico.filter(h => h.cliente_id === c.id);
            c.dividaTotal = registrosCliente.reduce((acc, h) => {
                const cascosPendentes = (h.qtd_casco || 0) - (h.qtd_casco_devolvido || 0);
                const caixasPendentes = (h.qtd_caixa || 0) - (h.qtd_caixa_devolvido || 0);
                return acc + cascosPendentes + caixasPendentes;
            }, 0);
        });

        mudarAba('tabHome');
    } catch (error) {
        console.error('Erro ao carregar dados iniciais:', error);
        alert('N√£o foi poss√≠vel conectar ao servidor.');
    }
};

const inicializarApp = () => {
    popularSelect('marcaCasco', OPCOES_MARCA_CASCO);
    popularSelect('tamanhoCasco', OPCOES_TAMANHO_CASCO);
    popularSelect('tipoCaixa', OPCOES_TIPO_CAIXA);
};
inicializarApp();

// --- L√ìGICA DE LOGIN ---
document.getElementById('formLogin').addEventListener('submit', async e => {
    e.preventDefault();
    const usuario = document.getElementById('loginUsuario').value.trim().toLowerCase();
    const senha = document.getElementById('loginSenha').value;
    const loginErro = document.getElementById('loginErro');
    loginErro.textContent = '';

    try {
        const response = await fetch(`${API_URL}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ usuario, senha })
        });
        if (response.ok) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            await carregarDadosIniciais(); // Aguarda o carregamento dos dados
        } else {
            const data = await response.json();
            loginErro.textContent = data.error || 'Utilizador ou palavra-passe inv√°lidos!';
        }
    } catch(error) {
        loginErro.textContent = 'Erro de conex√£o com o servidor.';
    }
});

// ======= NAVEGA√á√ÉO POR ABAS =======
const abas = ['Home', 'Fisicos', 'Bares', 'AdicionarCliente', 'Estoque', 'Apagados'];
const mudarAba = (tabId) => {
    abas.forEach(aba => {
        const el = document.getElementById(`conteudo${aba}`);
        if (el) el.style.display = 'none';
        document.getElementById(`tab${aba}`).classList.remove('active');
    });
    const abaAtiva = tabId.replace('tab', '');
    const elAtivo = document.getElementById(`conteudo${abaAtiva}`);
    if (elAtivo) elAtivo.style.display = 'block';
    document.getElementById(tabId).classList.add('active');

    // Renderiza o conte√∫do espec√≠fico da aba
    if (abaAtiva === 'Home') renderizarHome();
    if (abaAtiva === 'Fisicos') renderizarClientes('fisico');
    if (abaAtiva === 'Bares') renderizarClientes('bar');
    if (abaAtiva === 'Estoque') renderizarEstoque();
    if (abaAtiva === 'Apagados') renderizarRegistrosApagados();
    if (abaAtiva === 'AdicionarCliente') resetarFormCliente();
};

abas.forEach(aba => {
    const btn = document.getElementById(`tab${aba}`);
    if (btn) btn.addEventListener('click', () => mudarAba(`tab${aba}`));
});

// ======= RENDERIZA√á√ÉO DAS SEC√á√ïES =======

const renderizarHome = () => {
    // Renderiza hist√≥rico do dia
    const container = document.getElementById('historicoDoDia');
    container.innerHTML = '';
    if (historicoHoje.length === 0) {
        container.innerHTML = '<p>Nenhum empr√©stimo registado hoje.</p>';
    } else {
        historicoHoje.forEach(h => {
            const cascosInfo = h.qtd_casco > 0 ? `${h.qtd_casco} Casco(s) (${h.marca_casco})` : '';
            const caixasInfo = h.qtd_caixa > 0 ? `${h.qtd_caixa} Caixa(s) (${h.tipo_caixa})` : '';
            const div = document.createElement('div');
            div.className = 'item-lista';
            div.innerHTML = `
                <span><strong>Cliente:</strong> ${h.cliente_nome}</span>
                <span>${cascosInfo} ${caixasInfo}</span>
                <span><small>${new Date(h.data_emprestimo).toLocaleString('pt-BR')}</small></span>
            `;
            container.appendChild(div);
        });
    }

    // NOVA L√ìGICA: Atualiza estat√≠sticas da Home
    const totalPendentes = clientes.reduce((acc, c) => acc + c.dividaTotal, 0);
    const clientesComDebitos = clientes.filter(c => c.dividaTotal > 0).length;
    document.getElementById('totalItensPendentes').textContent = totalPendentes;
    document.getElementById('totalClientesComDebitos').textContent = clientesComDebitos;
};

const renderizarClientes = (tipo, filtroNome = '') => {
    const containerId = tipo === 'fisico' ? 'listaClientesFisicos' : 'listaClientesBares';
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    const filtrados = clientes
        .filter(c => c.tipo === tipo && c.nome.toLowerCase().includes(filtroNome.toLowerCase()))
        .sort((a, b) => b.dividaTotal - a.dividaTotal); // Ordena por maior d√≠vida

    if (filtrados.length === 0) {
        container.innerHTML = '<p>Nenhum cliente encontrado.</p>';
        return;
    }

    filtrados.forEach(c => {
        const div = document.createElement('div');
        div.className = 'item-lista';
        div.innerHTML = `
            <span><strong>${c.nome}</strong><br><small>${c.endereco}, ${c.numero}</small></span>
            <span class="divida">D√≠vida: ${c.dividaTotal} itens</span>
            <div class="botoes">
                <button class="secondary" onclick="abrirModal('modalHistoricoCliente', ${c.id})">Hist√≥rico</button>
                <button class="editar" onclick="editarCliente(${c.id})">Editar</button>
            </div>`;
        container.appendChild(div);
    });
};

const renderizarEstoque = () => {
    const container = document.getElementById('listaEstoque');
    container.innerHTML = '';
    estoque.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(item => {
        container.innerHTML += `
            <div class="estoque-item item-lista">
                <span>${item.nome}</span>
                <input type="number" id="estoque-${item.id}" value="${item.quantidade}" onchange="atualizarEstoque(${item.id})">
            </div>
        `;
    });
};

const renderizarRegistrosApagados = () => {
    const container = document.getElementById('listaRegistrosApagados');
    container.innerHTML = '';
    if (registrosApagados.length === 0) {
        container.innerHTML = '<p>Nenhum registo apagado.</p>';
        return;
    }
    registrosApagados.sort((a, b) => new Date(b.data_apagado) - new Date(a.data_apagado)).forEach(reg => {
        try {
            const dados = JSON.parse(reg.dados_originais);
            const cliente = clientes.find(c => c.id === dados.cliente_id);
            container.innerHTML += `
                <div class="apagado-item">
                    <p><strong>Data Apagado:</strong> ${new Date(reg.data_apagado).toLocaleString('pt-BR')}</p>
                    <p><strong>Justificativa:</strong> ${reg.justificativa}</p>
                    <p><strong>Cliente:</strong> ${cliente ? cliente.nome : 'Cliente Desconhecido'}</p>
                    <p><strong>Itens:</strong> Cascos: ${dados.qtd_casco}, Caixas: ${dados.qtd_caixa}</p>
                    <p><strong>Data Original:</strong> ${new Date(dados.data_emprestimo).toLocaleString('pt-BR')}</p>
                </div>
            `;
        } catch(e) { console.error("Erro ao processar registo apagado:", reg); }
    });
};

// ======= L√ìGICA DE PESQUISA =======
document.getElementById('pesquisaFisicos').addEventListener('input', (e) => renderizarClientes('fisico', e.target.value));
document.getElementById('pesquisaBares').addEventListener('input', (e) => renderizarClientes('bar', e.target.value));

// ======= GEST√ÉO DE CLIENTES =======
const resetarFormCliente = () => {
    document.getElementById('formCliente').reset();
    editClienteId = null;
    document.getElementById('formClienteTitulo').textContent = 'Registar Novo Cliente';
    document.getElementById('btnSalvarCliente').textContent = 'Guardar Cliente';
    document.getElementById('btnCancelarEdicao').style.display = 'none';
};

document.getElementById('btnCancelarEdicao').addEventListener('click', resetarFormCliente);

window.editarCliente = (id) => {
    mudarAba('tabAdicionarCliente');
    const cliente = clientes.find(c => c.id === id);
    if (!cliente) return;
    editClienteId = id;
    document.getElementById('nomeCliente').value = cliente.nome;
    document.getElementById('tipoCliente').value = cliente.tipo;
    document.getElementById('enderecoCliente').value = cliente.endereco;
    document.getElementById('numeroCliente').value = cliente.numero;
    document.getElementById('telefoneCliente').value = cliente.telefone || '';
    document.getElementById('formClienteTitulo').textContent = 'A editar Cliente';
    document.getElementById('btnSalvarCliente').textContent = 'Atualizar Cliente';
    document.getElementById('btnCancelarEdicao').style.display = 'block';
    document.getElementById('formCliente').scrollIntoView({ behavior: 'smooth', block: 'start' });
};

document.getElementById('formCliente').addEventListener('submit', async e => {
    e.preventDefault();
    const clienteData = {
        nome: document.getElementById('nomeCliente').value.trim(),
        tipo: document.getElementById('tipoCliente').value,
        endereco: document.getElementById('enderecoCliente').value.trim(),
        numero: document.getElementById('numeroCliente').value.trim(),
        telefone: document.getElementById('telefoneCliente').value.trim()
    };
    if (!clienteData.nome || !clienteData.tipo || !clienteData.endereco || !clienteData.numero) return alert("Todos os campos, exceto telefone, s√£o obrigat√≥rios!");

    try {
        const url = editClienteId ? `${API_URL}/clientes/${editClienteId}` : `${API_URL}/clientes`;
        const method = editClienteId ? 'PUT' : 'POST';
        const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(clienteData)
        });
        if (!response.ok) throw new Error((await response.json()).error || 'Erro no servidor');
        
        await carregarDadosIniciais();
        mudarAba(clienteData.tipo === 'fisico' ? 'tabFisicos' : 'tabBares');
    } catch(error) {
        alert(`Erro: ${error.message}`);
    }
});

// ======= GEST√ÉO DE ESTOQUE =======
window.atualizarEstoque = async (itemId) => {
    const input = document.getElementById(`estoque-${itemId}`);
    const quantidade = parseInt(input.value, 10);
    if (isNaN(quantidade)) return;

    try {
        const response = await fetch(`${API_URL}/estoque/${itemId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ quantidade })
        });
        if (!response.ok) throw new Error('Falha ao atualizar estoque.');
        const itemEstoque = estoque.find(i => i.id == itemId);
        if (itemEstoque) itemEstoque.quantidade = quantidade;
    } catch (error) {
        alert(error.message);
        carregarDadosIniciais();
    }
};


// ======= MODAIS, EMPR√âSTIMOS E DEVOLU√á√ïES =======
// Fun√ß√£o para formatar a data para o input datetime-local
const formatarDataParaInput = (date) => {
    const d = new Date(date);
    const ano = d.getFullYear();
    const mes = (d.getMonth() + 1).toString().padStart(2, '0');
    const dia = d.getDate().toString().padStart(2, '0');
    const horas = d.getHours().toString().padStart(2, '0');
    const minutos = d.getMinutes().toString().padStart(2, '0');
    return `${ano}-${mes}-${dia}T${horas}:${minutos}`;
};


window.abrirModal = (modalId, id) => {
    if (modalId === 'modalHistoricoCliente') {
        clienteAtualParaHistorico = clientes.find(c => c.id === id);
        if (!clienteAtualParaHistorico) return;
        
        document.getElementById('modalTituloCliente').textContent = `Hist√≥rico de: ${clienteAtualParaHistorico.nome}`;
        document.getElementById('infoClienteModal').textContent = `Endere√ßo: ${clienteAtualParaHistorico.endereco}, ${clienteAtualParaHistorico.numero}`;
        
        // NOVO: Adiciona a data atual ao abrir o modal de empr√©stimo
        document.getElementById('dataEmprestimo').value = formatarDataParaInput(new Date());

        renderHistoricoCliente(id);
    }
    if (modalId === 'modalDevolucao') {
        registroParaDevolverId = id;
        const registro = historico.find(h => h.id === registroParaDevolverId);
        const container = document.getElementById('devolucaoItens');
        container.innerHTML = '';
        const cascosPendentes = (registro.qtd_casco || 0) - (registro.qtd_casco_devolvido || 0);
        const caixasPendentes = (registro.qtd_caixa || 0) - (registro.qtd_caixa_devolvido || 0);

        if(cascosPendentes > 0) container.innerHTML += `<div><label>Devolver Cascos (${registro.marca_casco} ${registro.tamanho_casco}):</label><input type="number" id="qtdCascoDevolver" value="0" min="0" max="${cascosPendentes}"></div>`;
        if(caixasPendentes > 0) container.innerHTML += `<div><label>Devolver Caixas (${registro.tipo_caixa}):</label><input type="number" id="qtdCaixaDevolver" value="0" min="0" max="${caixasPendentes}"></div>`;
    }
    if (modalId === 'modalApagarRegistro') {
        registroParaApagarId = id;
    }
    document.getElementById(modalId).style.display = 'block';
};

window.fecharModal = (modalId) => {
    document.getElementById(modalId).style.display = 'none';
};

document.getElementById('formEmprestimo').addEventListener('submit', async e => {
    e.preventDefault();
    const novoRegistro = {
        cliente_id: clienteAtualParaHistorico.id,
        marcaCasco: document.getElementById('marcaCasco').value,
        tamanhoCasco: document.getElementById('tamanhoCasco').value,
        qtdCasco: parseInt(document.getElementById('qtdCasco').value, 10) || 0,
        tipoCaixa: document.getElementById('tipoCaixa').value,
        qtdCaixa: parseInt(document.getElementById('qtdCaixa').value, 10) || 0,
        // NOVO: Captura a data do formul√°rio
        data_emprestimo: document.getElementById('dataEmprestimo').value 
    };
    const temCasco = novoRegistro.qtdCasco > 0 && novoRegistro.marcaCasco !== 'Nenhuma' && novoRegistro.tamanhoCasco !== 'Nenhum';
    const temCaixa = novoRegistro.qtdCaixa > 0 && novoRegistro.tipoCaixa !== 'Nenhuma';
    if (!temCasco && !temCaixa) return alert("Adicione pelo menos um item.");
    
    try {
        const response = await fetch(`${API_URL}/historico`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(novoRegistro)
        });
        if (!response.ok) throw new Error('Falha ao guardar empr√©stimo.');
        await carregarDadosIniciais();
        document.getElementById('formEmprestimo').reset();
        document.getElementById('dataEmprestimo').value = formatarDataParaInput(new Date()); // Reseta para data atual
        renderHistoricoCliente(clienteAtualParaHistorico.id);
    } catch (error) {
        alert(`Erro: ${error.message}`);
    }
});

document.getElementById('formDevolucao').addEventListener('submit', async e => {
    e.preventDefault();
    const qtdCascoDev = parseInt(document.getElementById('qtdCascoDevolver')?.value || 0, 10);
    const qtdCaixaDev = parseInt(document.getElementById('qtdCaixaDevolver')?.value || 0, 10);
    try {
        const response = await fetch(`${API_URL}/historico/devolver/${registroParaDevolverId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ qtdCascoDev, qtdCaixaDev })
        });
        if (!response.ok) throw new Error('Falha ao registar devolu√ß√£o.');
        await carregarDadosIniciais();
        fecharModal('modalDevolucao');
        renderHistoricoCliente(clienteAtualParaHistorico.id);
    } catch (error) {
        alert(`Erro: ${error.message}`);
    }
});

document.getElementById('formApagar').addEventListener('submit', async e => {
    e.preventDefault();
    const justificativa = document.getElementById('justificativaApagar').value.trim();
    if (!justificativa) return alert('A justificativa √© obrigat√≥ria.');

    try {
        const response = await fetch(`${API_URL}/historico/${registroParaApagarId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ justificativa })
        });
        if (!response.ok) throw new Error((await response.json()).error || 'Falha ao apagar registo.');
        
        fecharModal('modalApagarRegistro');
        document.getElementById('formApagar').reset();
        await carregarDadosIniciais();
        renderHistoricoCliente(clienteAtualParaHistorico.id);

    } catch (error) {
        alert(`Erro: ${error.message}`);
    }
});


const renderHistoricoCliente = (clienteId) => {
    const lista = document.getElementById('listaHistoricoCliente');
    const resumoContainer = document.getElementById('resumoDividaCliente');
    lista.innerHTML = '';
    
    const registros = historico
        .filter(h => h.cliente_id === clienteId)
        .sort((a, b) => new Date(b.data_emprestimo) - new Date(a.data_emprestimo));

    if(registros.length === 0) {
        lista.innerHTML = '<p>Nenhum empr√©stimo registado.</p>';
        resumoContainer.style.display = 'none';
        return;
    }
    
    // NOVO: Calcula e exibe o resumo da d√≠vida do cliente
    const dividaCliente = registros.reduce((acc, h) => {
        acc.cascos += (h.qtd_casco || 0) - (h.qtd_casco_devolvido || 0);
        acc.caixas += (h.qtd_caixa || 0) - (h.qtd_caixa_devolvido || 0);
        return acc;
    }, {cascos: 0, caixas: 0});

    if (dividaCliente.cascos > 0 || dividaCliente.caixas > 0) {
         resumoContainer.innerHTML = `D√çVIDA ATUAL: ${dividaCliente.cascos} Casco(s) e ${dividaCliente.caixas} Caixa(s)`;
         resumoContainer.style.display = 'block';
    } else {
         resumoContainer.style.display = 'none';
    }


    registros.forEach(h => {
        const cascosPendentes = (h.qtd_casco || 0) - (h.qtd_casco_devolvido || 0);
        const caixasPendentes = (h.qtd_caixa || 0) - (h.qtd_caixa_devolvido || 0);
        const totalPendente = cascosPendentes + caixasPendentes;
        
        const cascosInfo = h.qtd_casco > 0 ? `Cascos: ${h.qtd_casco_devolvido}/${h.qtd_casco} (${h.marca_casco})` : '';
        const caixasInfo = h.qtd_caixa > 0 ? `Caixas: ${h.qtd_caixa_devolvido}/${h.qtd_caixa} (${h.tipo_caixa})` : '';

        const div = document.createElement('div');
        div.className = 'item-lista';
        div.innerHTML = `
            <span><strong>Data:</strong> ${new Date(h.data_emprestimo).toLocaleString('pt-BR')}<br><strong>Pendente:</strong> ${totalPendente}</span>
            <span>${cascosInfo}<br>${caixasInfo}</span>
            <div class="botoes">
                ${totalPendente > 0 ? `<button class="devolver" onclick="abrirModal('modalDevolucao', ${h.id})">Devolver</button>` : ''}
                <button class="imprimir-recibo" onclick="imprimirRecibo(${h.id})">Recibo</button>
                <button class="apagar" onclick="abrirModal('modalApagarRegistro', ${h.id})">Apagar</button>
            </div>
        `;
        lista.appendChild(div);
    });
};

// ======= WHATSAPP =======
document.getElementById('btnNotificarWhatsapp').addEventListener('click', () => {
    if (!clienteAtualParaHistorico || !clienteAtualParaHistorico.telefone) {
        return alert('Este cliente n√£o tem um n√∫mero de telefone registado.');
    }
    const mensagem = `üì¢ Ol√°, tudo bem?\n\nAqui √© o sistema de controle de vasilhames da Distribuidora Garcia.\nüîé Notamos uma pend√™ncia de cascos e/ou caixas em seu cadastro.\nüìÖ Por favor, entre em contato para agendarmos a devolu√ß√£o.\n\nSe voc√™ j√° devolveu, √© s√≥ ignorar esta mensagem.\nObrigado pela aten√ß√£o!\nDistribuidora Garcia ‚úÖ`;
    const urlWhatsapp = `https://wa.me/${clienteAtualParaHistorico.telefone}?text=${encodeURIComponent(mensagem)}`;
    window.open(urlWhatsapp, '_blank');
});

// ======= IMPRESS√ÉO =======
function printHelper(printContents, title, isReceipt = false) {
    const printWindow = window.open('', '_blank');
    let styles = `
        body { 
            font-family: Arial, sans-serif;
            font-weight: bold; /* APLICA NEGRITO A TUDO */
        } 
        h1, h2, h3 { text-align: center; margin: 10px 0; } 
        p, li { margin: 4px 0; } 
        ul { list-style-position: inside; padding-left: 0; } 
        table { width: 100%; border-collapse: collapse; margin-top: 15px; } 
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; page-break-inside: avoid; }
        th { background-color: #f2f2f2; }
        .logo-print { max-width: 150px; display: block; margin: 0 auto 10px; }
        .summary-section { margin-top: 20px; padding: 15px; border-top: 2px solid black;}
        .summary-section h3 { text-align: left; }
        .no-print { display: none; }
    `;
    if (isReceipt) {
        styles += `
            @page { size: 80mm; margin: 2mm; } 
            body { font-size: 10pt; }
            h1 { font-size: 14pt; }
            h2 { font-size: 12pt; }
        `;
    }

    printWindow.document.write(`
        <html>
            <head>
                <title>${title}</title>
                <style>${styles}</style>
            </head>
            <body>${printContents}</body>
        </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
}

// NOVO: Bot√£o para imprimir Resumo do Dia
document.getElementById('btnImprimirResumoDiario').addEventListener('click', () => {
    let content = `
        <img src="logo.png" alt="Logo Distribuidora Garcia" class="logo-print">
        <h1>Resumo do Dia</h1>
        <p>Data do Relat√≥rio: ${new Date().toLocaleDateString('pt-BR')}</p>
        <hr>
    `;

    const registrosDeHoje = historico.filter(h => new Date(h.data_emprestimo).toDateString() === new Date().toDateString());

    if (registrosDeHoje.length === 0) {
        content += '<p>Nenhuma movimenta√ß√£o registrada hoje.</p>';
    } else {
        content += '<h2>Empr√©stimos Realizados Hoje</h2><table><thead><tr><th>Cliente</th><th>Itens</th><th>Hor√°rio</th></tr></thead><tbody>';
        registrosDeHoje.forEach(h => {
            const cliente = clientes.find(c => c.id === h.cliente_id);
            let itens = '<ul>';
            if (h.qtd_casco > 0) itens += `<li>${h.qtd_casco} x Casco ${h.marca_casco}</li>`;
            if (h.qtd_caixa > 0) itens += `<li>${h.qtd_caixa} x Caixa ${h.tipo_caixa}</li>`;
            itens += '</ul>';

            content += `
                <tr>
                    <td>${cliente ? cliente.nome : 'Cliente n√£o encontrado'}</td>
                    <td>${itens}</td>
                    <td>${new Date(h.data_emprestimo).toLocaleTimeString('pt-BR')}</td>
                </tr>
            `;
        });
        content += '</tbody></table>';
    }

    printHelper(content, 'Resumo do Dia');
});


// Bot√£o para imprimir Extrato Geral de Empr√©stimos
document.getElementById('btnImprimirExtratoEmprestimos').addEventListener('click', () => {
    const totais = { cascos: {}, caixas: {}, totalGeral: 0 };

    let content = `
        <img src="logo.png" alt="Logo Distribuidora Garcia" class="logo-print">
        <h1>Extrato Geral de Empr√©stimos Pendentes</h1>
        <p>Data do Relat√≥rio: ${new Date().toLocaleDateString('pt-BR')}</p>
        <hr>
    `;

    const clientesComDivida = clientes.filter(c => c.dividaTotal > 0).sort((a,b) => a.nome.localeCompare(b.nome));
    let htmlClientes = '<table><thead><tr><th>Cliente</th><th>Itens Pendentes</th></tr></thead><tbody>';

    clientesComDivida.forEach(cliente => {
        let itensCliente = '<ul>';
        historico.filter(h => h.cliente_id === cliente.id).forEach(h => {
            const cascosPendentes = (h.qtd_casco || 0) - (h.qtd_casco_devolvido || 0);
            const caixasPendentes = (h.qtd_caixa || 0) - (h.qtd_caixa_devolvido || 0);

            if (cascosPendentes > 0) {
                const key = `${h.marca_casco} ${h.tamanho_casco}`;
                totais.cascos[key] = (totais.cascos[key] || 0) + cascosPendentes;
                totais.totalGeral += cascosPendentes;
                itensCliente += `<li>${cascosPendentes} x Casco ${key}</li>`;
            }
            if (caixasPendentes > 0) {
                const key = h.tipo_caixa;
                totais.caixas[key] = (totais.caixas[key] || 0) + caixasPendentes;
                totais.totalGeral += caixasPendentes;
                itensCliente += `<li>${caixasPendentes} x Caixa ${key}</li>`;
            }
        });
        itensCliente += '</ul>';
        htmlClientes += `<tr><td><strong>${cliente.nome}</strong><br><small>${cliente.endereco}, ${cliente.numero}</small></td><td>${itensCliente}</td></tr>`;
    });
    htmlClientes += '</tbody></table>';
    
    let resumoHtml = '<div class="summary-section"><h2>Resumo Total de Itens Pendentes</h2>';
    resumoHtml += '<h3>Cascos:</h3><ul>';
    Object.keys(totais.cascos).sort().forEach(key => resumoHtml += `<li><strong>${totais.cascos[key]}</strong> x ${key}</li>`);
    resumoHtml += '</ul><h3>Caixas:</h3><ul>';
    Object.keys(totais.caixas).sort().forEach(key => resumoHtml += `<li><strong>${totais.caixas[key]}</strong> x ${key}</li>`);
    resumoHtml += `</ul><hr><h3>TOTAL GERAL DE ITENS PENDENTES: ${totais.totalGeral}</h3></div>`;

    content += resumoHtml + htmlClientes;
    printHelper(content, 'Extrato Geral de Empr√©stimos');
});

// NOVO: Bot√£o para imprimir Extrato de Estoque
document.getElementById('btnImprimirExtratoEstoque').addEventListener('click', () => {
    let content = `
        <img src="logo.png" alt="Logo Distribuidora Garcia" class="logo-print">
        <h1>Extrato de Estoque</h1>
        <p>Data do Relat√≥rio: ${new Date().toLocaleDateString('pt-BR')}</p>
        <hr>
        <table>
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Quantidade em Estoque</th>
                </tr>
            </thead>
            <tbody>
    `;
    estoque.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(item => {
        content += `
            <tr>
                <td>${item.nome}</td>
                <td>${item.quantidade}</td>
            </tr>
        `;
    });
    content += '</tbody></table>';
    printHelper(content, 'Extrato de Estoque');
});


// Fun√ß√£o de impress√£o de recibo individual (ATUALIZADA COM LOGO)
window.imprimirRecibo = (registroId) => {
    const registro = historico.find(h => h.id === registroId);
    const cliente = clientes.find(c => c.id === registro.cliente_id);
    if (!registro || !cliente) return;
    
    let conteudo = `
        <img src="logo.png" alt="Logo Distribuidora Garcia" class="logo-print">
        <h1>Distribuidora Garcia</h1>
        <h2>Recibo de Empr√©stimo</h2>
        <p>--------------------------------</p>
        <p><strong>Cliente:</strong> ${cliente.nome}</p>
        <p><strong>Data:</strong> ${new Date(registro.data_emprestimo).toLocaleString('pt-BR')}</p>
        <p>--------------------------------</p>
        <h3>Itens Emprestados:</h3>
        <ul>
    `;
    if(registro.qtd_casco > 0) conteudo += `<li>${registro.qtd_casco} x Casco ${registro.marca_casco} ${registro.tamanho_casco}</li>`;
    if(registro.qtd_caixa > 0) conteudo += `<li>${registro.qtd_caixa} x Caixa ${registro.tipo_caixa}</li>`;
    
    conteudo += `
        </ul>
        <p>--------------------------------</p>
        <p>Assinatura do Cliente:</p>
        <br><br>
        <p>_________________________</p>
    `;
    
    printHelper(conteudo, 'Recibo', true);
}


}); // Fim do DOMContentLoaded
</script>

</body>
</html>